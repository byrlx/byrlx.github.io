---
layout: post
title: 从Topeka项目学习Material Design (/*未完待续*/)
description: [Android Topeka是一个典型的Material Design风格的应用, 本文同过对其代码的学习, 更深入的了解Material Design在Android项目中的应用]
tag: [Android, Material Design,  TBD]
---

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 项目配置</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>minSdkVersion: 21
由于Material Design是随着Android5.0发布, 所以一般情况下支持的sdk最小版本为21, 如果要再5.0之前的系统使用, 
可以参考Android开发者官网关于Material Desing兼容性的相关文章.
</li>
<li>使用的依赖
<ul class="org-ul">
<li>compile 'com.android.support:cardview-v7:22.2.0'
</li>
<li>compile 'com.android.support:recyclerview-v7:22.2.0'
</li>
</ul>
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 项目结构</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> 组件</h3>
<div class="outline-text-3" id="text-2-1">
<p>
该项目的AndroidManifest.xml中只有三个Activity.其中登陆界面是默认的启动界面.
</p>

<div class="org-src-container">

<pre class="src src-xml">&lt;activity android:name=".activity.SignInActivity"
	    android:windowSoftInputMode="adjustPan"&gt;
	    &lt;intent-filter&gt;
		&lt;action android:name="android.intent.action.MAIN" /&gt;
		&lt;category android:name="android.intent.category.LAUNCHER" /&gt;
	    &lt;/intent-filter&gt;
	&lt;/activity&gt;

&lt;activity android:name=".activity.CategorySelectionActivity" /&gt;

&lt;activity android:name=".activity.QuizActivity"
	    android:parentActivityName=".activity.CategorySelectionActivity"
	    android:windowSoftInputMode="adjustPan" /&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> 自定义Theme</h3>
<div class="outline-text-3" id="text-2-2">
</div><div id="outline-container-sec-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> 该程序使用了自定义的Theme, 该Theme定义在style.xml文件中, 名称为Topeka.</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">

<pre class="src src-xml">&lt;application
    android:allowBackup="true"
    android:hardwareAccelerated="true"
    android:icon="@mipmap/ic_launcher"
    android:label="@string/app_name"
    android:supportsRtl="false"
    android:theme="@style/Topeka"&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2-2-2" class="outline-4">
<h4 id="sec-2-2-2"><span class="section-number-4">2.2.2</span> Topeka的实现, 先看下源码.</h4>
<div class="outline-text-4" id="text-2-2-2">
<div class="org-src-container">

<pre class="src src-xml">&lt;style name="Topeka" parent="@android:style/Theme.Material.Light.NoActionBar"&gt;
    &lt;item name="android:colorPrimary"&gt;@color/topeka_primary&lt;/item&gt;
    &lt;item name="android:colorPrimaryDark"&gt;@color/topeka_primary_dark&lt;/item&gt;
    &lt;item name="android:colorAccent"&gt;@color/topeka_accent&lt;/item&gt;
    &lt;item name="android:textColorPrimary"&gt;@android:color/black&lt;/item&gt;
    &lt;item name="android:textColorPrimaryInverse"&gt;@color/text_light&lt;/item&gt;
    &lt;item name="android:statusBarColor"&gt;@color/topeka_primary_dark&lt;/item&gt;
    &lt;item name="android:textColor"&gt;@color/text_dark&lt;/item&gt;
    &lt;item name="android:radioButtonStyle"&gt;@style/Topeka.CompoundButton.Radio&lt;/item&gt;
    &lt;item name="android:windowContentTransitions"&gt;true&lt;/item&gt;
    &lt;item name="android:titleTextAppearance"&gt;@style/Topeka.TextAppearance.Title&lt;/item&gt;
    &lt;item name="android:buttonStyle"&gt;@style/Topeka.CompoundButton&lt;/item&gt;
    &lt;item name="android:windowBackground"&gt;@color/light_grey&lt;/item&gt;
&lt;/style&gt;
</pre>
</div>
<p>
可以看到该style继承了 <b>Theme.Material.Light.NoActionBar</b> 风格, 这事Material Design的一个风格.
同时应用也重写了该风格的一些属性:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Name</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">colorPrimary</td>
<td class="left">标题栏颜色</td>
</tr>

<tr>
<td class="left">colorPrimaryDark</td>
<td class="left">状态栏颜色</td>
</tr>

<tr>
<td class="left">colorAccent</td>
<td class="left">像是checkbox颜色?</td>
</tr>

<tr>
<td class="left">textColorPrimary</td>
<td class="left">标题栏字体</td>
</tr>

<tr>
<td class="left">textColorPrimaryInverse</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">statusBarColor</td>
<td class="left">状态栏颜色</td>
</tr>

<tr>
<td class="left">textColor</td>
<td class="left">字体颜色</td>
</tr>

<tr>
<td class="left">radioButtonStyle</td>
<td class="left">自定义style</td>
</tr>

<tr>
<td class="left">windowContentTransitions</td>
<td class="left">动画转化效果</td>
</tr>

<tr>
<td class="left">titleTextAppearance</td>
<td class="left">自定义style</td>
</tr>

<tr>
<td class="left">buttonStyle</td>
<td class="left">自定义style</td>
</tr>

<tr>
<td class="left">windowBackground</td>
<td class="left">window背景</td>
</tr>
</tbody>
</table>

<p>
重写的属性大部分都使用了单一的值, 只有radioButtonStyle/titleTextAppearance/buttonStyle这三个使用了
自定义的风格.自定义的style都放在drawable目录下.以radioButtonStyle为例
</p>

<div class="org-src-container">

<pre class="src src-xml">//style.xml
    &lt;style name="Topeka.CompoundButton.Radio" parent="Topeka.CompoundButton"&gt;
	&lt;item name="android:background"&gt;@drawable/selector_checkable&lt;/item&gt;
    &lt;/style&gt;

//res/drawable/selector_checkable.xml
&lt;ripple xmlns:android="http://schemas.android.com/apk/res/android"
    android:color="?android:attr/colorControlHighlight"&gt;
    &lt;item&gt;
	&lt;selector&gt;
	    &lt;item android:state_checked="false"&gt;
		&lt;color android:color="?android:attr/colorButtonNormal" /&gt;
	    &lt;/item&gt;
	    &lt;item android:state_checked="true"&gt;
		&lt;color android:color="?android:attr/colorPrimary" /&gt;
	    &lt;/item&gt;
	&lt;/selector&gt;
    &lt;/item&gt;
&lt;/ripple&gt;
</pre>
</div>

<p>
ripple用于设置水纹效果.
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 登陆界面 SignInActivity.java</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> onCreate()</h3>
<div class="outline-text-3" id="text-3-1">
<p>
在onCreate函数中,直接通过FragmentManager启动一个SignInFragment的实例来显示登录界面.
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> SignInFragment</h3>
<div class="outline-text-3" id="text-3-2">
<p>
SignInFragment会在onCreateView中会判断是否需要登录, 如果不需要则直接进入CategoryActivity页面,
如果需要, 则显示登录信息, 输入登录信息后, 再跳转到CategoryActivity页面.
上述过程有两个地方用到了MaterialDesign的设计
</p>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Material Design 1: DonFab (Floating Button)</h3>
<div class="outline-text-3" id="text-3-3">
<p>
在SignInFragment中会让用户填写姓名和选择头像, 当用户填写完FirstName后, 左下角就会出现一个floating button,
点击即可进入Category Activity, 这个Floating Button即是Material Design的风格之一.
</p>
</div>
<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> 实现</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
SignInFragment中FloatingButton的具体实现为DoneFab类, 该类继承自 FloatingActionButton,后者也是该应用的
自定义view, 继承自ImageView.
</p>

<div class="org-src-container">

<pre class="src src-java">public FloatingActionButton(Context context, AttributeSet attrs, int defStyle) {
    super(context, attrs, defStyle);
    setFocusable(true);
    setClickable(true);
    setOutlineProvider(new FabOutlineProvider());
    setClipToOutline(true);
    setScaleType(ScaleType.CENTER_INSIDE);
    setBackgroundResource(R.drawable.fab_background);
    setElevation(getResources().getDimension(R.dimen.elevation_fab));
}
</pre>
</div>

<ol class="org-ol">
<li>在Material的主题中,通过设置view的elevation即可让主题呈现出阴影效果.
</li>
<li>通过重写RoundOutlineProvider()函数来设置button的size大小.
</li>
<li>通过使用自定义backgroundResource来设置按钮的水纹点击效果, holo_green_dark即为
   水纹颜色.
<div class="org-src-container">

<pre class="src src-java">&lt;ripple xmlns:android="http://schemas.android.com/apk/res/android"
    android:color="@android:color/holo_green_dark"&gt;
    &lt;item android:drawable="@android:color/white" /&gt;
&lt;/ripple&gt;
</pre>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Material Design 2: 动画过渡</h3>
<div class="outline-text-3" id="text-3-4">
<p>
当输入完名称, 点击确定按钮时, 按钮的水纹效果完成后, 会进入CategoryActivity界面, 从视觉上来看, 
确定按钮从登陆界面的右下角移动到了Category界面的左上角,并变成了头像. 这种控件在两个activity之间的
移动也是MaterialDesign的一种风格.
</p>
</div>
<div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> 实现</h4>
<div class="outline-text-4" id="text-3-4-1">
<ol class="org-ol">
<li>当单击登录界面的确定按钮时, 会执行performSignInWithTransition()函数跳转到
CategoryActivity中.该函数的实现如下:

<div class="org-src-container">

<pre class="src src-java">private void performSignInWithTransition(View v) {
    Activity activity = getActivity();
    ActivityOptions activityOptions = ActivityOptions
	    .makeSceneTransitionAnimation(activity, v,
		    activity.getString(R.string.transition_avatar));
    CategorySelectionActivity.start(activity, mPlayer, activityOptions);
    activity.finishAfterTransition();
}
</pre>
</div>

<p>
通过代码可以看到, 在启动activity时传入了一个ActivityOptions参数, 该参数是通过调用
makeSceneTransitionAnimation()生成.该函数接受三个参数:
</p>
<ul class="org-ul">
<li>activity: 包含 <b>共享元素</b> 的activity. 在这里即为SignInActivity.
</li>
<li>view: 共享元素在activity中的值. 在这里即为SignInFragment中的确定按钮.
</li>
<li>name: 目标activity中 <b>共享元素</b> 的transitionName值. 
这里为CatogeryActivity中该名称的view.打开Category的layout文件可以找transitionName值为
name的值.可以看到该view即为category界面的头像.所以从登录界面跳刀category界面时, 右下角的登录按钮会
变化为左上角的头像按钮.

<div class="org-src-container">

<pre class="src src-java">&lt;com.google.samples.apps.topeka.widget.AvatarView
    android:id="@+id/avatar"
    android:layout_width="@dimen/size_fab"
    android:layout_height="@dimen/size_fab"
    android:layout_marginEnd="@dimen/spacing_double"
    android:transitionName="@string/transition_avatar" /&gt;
</pre>
</div>
</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Category界面</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> onCreate() and Layout</h3>
<div class="outline-text-3" id="text-4-1">
</div><div id="outline-container-sec-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> 标题栏: toolbar</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
该activity的标题栏使用了Toolbar这个控件, 然后再onCreate()函数中通过调用
setActionBar(toolbar)将toolbar作为传统的actionbar使用.同时activity的
option menu也会添加到toolbar上.
</p>

<p>
最后在onCreate()里加载CategoryGridFragment的一个实例.
</p>
</div>
</div>

<div id="outline-container-sec-4-1-2" class="outline-4">
<h4 id="sec-4-1-2"><span class="section-number-4">4.1.2</span> CategoryGridFragment</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
该fragment使用了GridView来显示目录列表.每个列表项由一个图片和文字构成.
使用到的gridview属性
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">&#xa0;</th>
<th scope="col" class="left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">drawSelectorOnTop</td>
<td class="left">选中条目的时候颜色是否显示在上边</td>
</tr>

<tr>
<td class="left">listSelector</td>
<td class="left">选中条目时的可绘制对象</td>
</tr>

<tr>
<td class="left">clipToPadding</td>
<td class="left">如果ListView/GridView设置了paddingTop/Bottom. 该值为true,滚动时padding不会消失. false会消失.</td>
</tr>

<tr>
<td class="left">scrollBarStyle</td>
<td class="left">outsideOverlay, 滚动时显示滚动条</td>
</tr>
</tbody>
</table>

<p>
listSelector同样使用了ripple风格. 通过设置mask的shape可以设置水纹的形状.
</p>

<div class="org-src-container">

<pre class="src src-xml">&lt;ripple xmlns:android="http://schemas.android.com/apk/res/android"
    android:color="@color/touch_effect"&gt;
    &lt;item android:id="@android:id/mask"&gt;
	&lt;shape android:shape="rectangle"&gt;
	    &lt;solid android:color="@android:color/white" /&gt;
	&lt;/shape&gt;
    &lt;/item&gt;
&lt;/ripple&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Material Design 3: 多动画过渡</h3>
<div class="outline-text-3" id="text-4-2">
<p>
从category界面选中某一项会打开该类别的答题界面, 在页面切换过程中,
该项的文字栏会变成下一页的标题栏, 而头像会变成播放按钮.这种同时有多个
view进行动画过渡的效果是通过ActivityOptions.makeSceneTransitionAnimation()
函数实现的.
</p>

<div class="org-src-container">

<pre class="src src-android">//find activity view
AvatarView avatarView = (AvatarView)getActivity().findViewById(R.id.lx_avatar);
// Create pair of transition participants.
List&lt;Pair&gt; participants = new ArrayList&lt;&gt;(3);
participants.add(new Pair&lt;&gt;(toolbar, activity.getString(R.string.transition_toolbar)));
participants.add(new Pair&lt;&gt;(avatarView, activity.getString(R.string.transition_avatar)));
@SuppressWarnings("unchecked")
ActivityOptions sceneTransitionAnimation = ActivityOptions
	.makeSceneTransitionAnimation(activity,
		participants.toArray(new Pair[participants.size()]));

// Starts the activity with the participants, animating from one to the other.
final Bundle transitionBundle = sceneTransitionAnimation.toBundle();
activity.startActivity(QuizActivity.getStartIntent(activity, category), transitionBundle);
</pre>
</div>

<p>
在下一页的layout文件中设置了相应的transitionName
</p>

<div class="org-src-container">

<pre class="src src-android">&lt;com.google.samples.apps.topeka.widget.fab.FloatingActionButton
    android:id="@+id/fab_quiz"
    android:layout_width="@dimen/size_fab"
    android:layout_height="@dimen/size_fab"
    android:layout_gravity="bottom|end"
    android:layout_marginBottom="@dimen/spacing_double"
    android:layout_marginEnd="@dimen/spacing_double"
    android:transitionName="@string/transition_avatar" /&gt;  &lt;---here----&gt;

&lt;LinearLayout
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"&gt;

    &lt;Toolbar
	android:id="@+id/toolbar_activity_quiz"
	android:layout_width="match_parent"
	android:layout_height="?android:attr/actionBarSize"
	android:layout_gravity="top"
	android:background="?android:colorPrimary"
	android:contentInsetStart="@dimen/spacing_huge"
	android:elevation="@dimen/elevation_header"
	android:navigationContentDescription="@string/up"
	android:navigationIcon="@drawable/ic_arrow_back"
	android:transitionName="@string/transition_toolbar"&gt; &lt;---here----&gt;
    &lt;/Toolbar&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 答题页</h2>
</div>
