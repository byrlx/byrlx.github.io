---
layout: post
title: Memory Optimization
description: [Some methods to analyze memory usage]
tag: [Tool, Performance]
---

<p>
For a Samsung Galaxy Note 4 memory usage high issue: Setting-&gt;App-&gt;Running.
(Not that high in Nexus5).Try to analyze why this happens.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">GC_XXX logs</h2>
<div class="outline-text-2" id="text-1">
<p>
After first install and run, the memory usage is about 200MB.
about 20+ GC_FOR_ALLOC logs show. as this
</p>

<blockquote>
<p>
<i>/ GC_FOR_ALLOC: A garbage collection caused because your app attempted to allocate memory when 
/</i> your heap was already full, so the system had to stop your app and reclaim memory.
02-02 15:51:24.227  8351  8351 D dalvikvm: GC_FOR_ALLOC freed 2786K, 12% free 75674K/85580K, paused 62ms, total 62ms
</p>
</blockquote>

<p>
Do some image related operations(wallpaper,recommendation&#x2026;), the memory become 260+MB, 
More GC_FOR_ALLOC logs show, and serveral GC_EXPLICIT logs.
</p>

<p>
"GC_EXPLICIT
An explicit garbage collection, such as when you call gc() 
(which you should avoid calling and instead trust the garbage collector to run when needed)."
</p>

<p>
From the GC logs, check if <b>75674K/85580K</b> is continue growing, if so, there maybe leak.
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">DDMS VM heap</h2>
<div class="outline-text-2" id="text-2">
<p>
Use ddms vm heap feature to chech the heap change while interacting with app,
as blew.
</p>


<div class="figure">
<p><img src="../../../assets/images/ddmsvmheap.png" alt="ddmsvmheap.png" />
</p>
</div>

<p>
From the image, the 1-byte array mallocs about 84MB, the <b>56byte</b> malloc is
about more than 2000.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Allocation Tracker</h2>
<div class="outline-text-2" id="text-3">
<p>
Allcation Tracker can show all the allocations and the code path.
</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">dumpsys meminfo pid/packagename</h2>
<div class="outline-text-2" id="text-4">
<p>
This command used to  lists all of your app's current allocations, measured in kilobytes.
</p>

<p>
Import columns and line combinations need concerded:
</p>
<ol class="org-ol">
<li>Dalvik heap + private dirty.
It's your app's heap allocation.
</li>
<li>.dex mmap + private clean.
The own code size of your app.
</li>
<li>Unknow + private Dirty.
Allocation belongs to your app but can't classified by system.
</li>
<li>private dirty column.
Your own memory use, this memory is pages that been modified, 
so must stay in memory.
</li>
<li>private clean colum.
Still your apps own memory alloc, but not modified, then can be 
paged out.
</li>
<li><b>Appcontext and Activity</b>.
A very important part to track activity memory leak.
</li>
</ol>

<p>
Below is a dumpsys meminfo output, there maybe activity leak, because 
when the first activity called <b>finish()</b>, and we suppose it be recycled
after GC. But it's not.
</p>

<div class="org-src-container">

<pre class="src src-c">MEMINFO in pid 10391 [com.luis.404] 
		   Pss  Private  Private  Swapped     Heap     Heap     Heap
		 Total    Dirty    Clean    Dirty     Size    Alloc     Free
		------   ------   ------   ------   ------   ------   ------
  Native Heap       48       48        0        0    53504     7614    25489
  Dalvik Heap    18984    18860        0        0    34808    26160     8648
 Dalvik Other     3772     3740        0        0                           
	Stack      152      152        0        0                           
    Other dev     3388     3380        8        0                           
     .so mmap     4759     3576      620        0                           
    .jar mmap        4        0        4        0                           
    .apk mmap      343        0      228        0                           
    .ttf mmap        1        0        0        0                           
    .dex mmap     5851       80     5340        0                           
   Other mmap        8        4        0        0                           
      Unknown    27345    27344        0        0                           
	TOTAL    64655    57184     6200        0    88312    33774    34137

 Objects
	       Views:       19         ViewRootImpl:        1
	 AppContexts:        5           Activities:        2
	      Assets:        5        AssetManagers:        5
       Local Binders:       78        Proxy Binders:       24
    Death Recipients:        0
     OpenSSL Sockets:        3

 SQL
	 MEMORY_USED:     1103
  PAGECACHE_OVERFLOW:      667          MALLOC_SIZE:       62
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">dumpsys procstats packagename</h2>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">heap dump</h2>
<div class="outline-text-2" id="text-6">
<p>
It will dump to a hprof file.
</p>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">some good post online</h2>
<div class="outline-text-2" id="text-7">
<p>
<a href="http://blog.hsc.com/android/technology-trends/android-memory-optimization/">http://blog.hsc.com/android/technology-trends/android-memory-optimization/</a>
<a href="https://developer.android.com/tools/debugging/debugging-memory.html">https://developer.android.com/tools/debugging/debugging-memory.html</a>
</p>
</div>
</div>
