<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.43 in css mode. -->
<html>
  <head>
    <title>Android-&#28040;&#24687;&#26426;&#21046;&#28304;&#30721;&#31508;&#35760;.org</title>
    <style type="text/css">
    <!--
      body {
        color: #DCDCCC;
        background-color: #3F3F3F;
      }
      .org-block {
        /* org-block */
        color: #009acd;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #7F9F7F;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #7F9F7F;
      }
      .org-document-info {
        /* org-document-info */
        color: #afeeee;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #DFAF8F;
        font-size: 130%;
        text-decoration: overline;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #BFEBBF;
        font-size: 120%;
      }
      .org-link {
        /* org-link */
        color: #D0BF8F;
        text-decoration: underline;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #7F9F7F;
      }
      .org-table {
        /* org-table */
        color: #9FC59F;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+OPTIONS: toc:t H:3</span>
<span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">Zhengchao Xu
</span><span class="org-document-info-keyword">#+EMAIL:</span> <span class="org-document-info">xuzhengchaojob@gmail.com
</span>
<span class="org-document-info-keyword">#+TITLE:</span> <span class="org-document-title">Android &#28040;&#24687;&#26426;&#21046;&#28304;&#30721;&#31508;&#35760;
</span>&#26412;&#31508;&#35760;&#26159;Android&#20013;&#23545;Handler&#30456;&#20851;&#21407;&#29702;&#30340;&#20195;&#30721;&#38405;&#35835;&#31508;&#35760;.

<span class="org-level-1">* Message</span>
  &#35813;&#31867;&#26159;&#25551;&#36848;&#20102;&#29992;&#20110;&#20316;&#20026;&#20449;&#24687;&#36733;&#20307;&#30340;"&#28040;&#24687;"&#30340;&#23454;&#29616;, &#20960;&#20010;&#37325;&#35201;&#30340;&#25104;&#21592;&#21464;&#37327;.
<span class="org-table">|           | &#25551;&#36848;                                                                                                                      |</span>
<span class="org-table">|-----------+---------------------------------------------------------------------------------------------------------------------------|</span>
<span class="org-table">| what      | &#35813;&#21464;&#37327;&#21487;&#20197;&#29992;&#26469;&#21807;&#19968;&#30340;&#26631;&#24535;&#26465;&#28040;&#24687;, &#22240;&#20026;&#27599;&#20010;handler&#37117;&#26377;&#33258;&#24049;&#30340;&#21629;&#21517;&#31354;&#38388;, &#25152;&#20197;&#21457;&#32473;&#19981;&#21516;handler&#30340;message, &#21363;&#20351;what&#30456;&#21516;, &#20063;&#19981;&#20250;&#20914;&#31361; |</span>
<span class="org-table">| arg1/arg2 | &#22914;&#26524;&#20256;&#36865;&#30340;&#28040;&#24687;&#21482;&#26159;&#31616;&#21333;&#30340;int&#31867;&#22411;, &#21487;&#20197;&#30452;&#25509;&#20351;&#29992;&#36825;&#20457;                                                                         |</span>
<span class="org-table">| when      | &#28040;&#24687;&#30340;&#28608;&#27963;&#26102;&#38388;                                                                                                            |</span>
<span class="org-table">| data      | Bundle&#31867;&#22411;, &#21457;&#36865;&#30340;&#25968;&#25454;, &#36890;&#36807;setData()&#35774;&#32622;                                                                                 |</span>
<span class="org-table">| target    | &#30446;&#26631;Handler                                                                                                               |</span>
<span class="org-table">| callback  |                                                                                                                           |</span>
<span class="org-level-2">** &#28040;&#24687;&#27744;</span>
Message&#31867;&#26412;&#36523;&#20063;&#23450;&#20041;&#20102;&#19968;&#20010;&#28040;&#24687;&#27744;, &#36890;&#36807;&#38142;&#34920;&#26041;&#24335;&#23384;&#20648;, &#21464;&#37327; sPoolSize &#23450;&#20041;&#20102;&#28040;&#24687;&#27744;&#30340;&#22823;&#23567;,
&#28040;&#24687;&#27744;&#30340;&#25805;&#20316;&#37117;&#26159;&#32447;&#31243;&#23433;&#20840;&#30340;. 
<span class="org-level-2">** &#33719;&#21462;&#28040;&#24687;</span>
obtain(...)&#20989;&#25968;&#26063;&#29992;&#20110;&#33719;&#21462;&#28040;&#24687;, &#36825;&#20123;obtain()&#20989;&#25968;&#36890;&#36807;&#19981;&#21516;&#30340;&#25509;&#21463;&#19981;&#21516;&#30340;
&#21442;&#25968;&#26469;&#21021;&#22987;&#21270;&#33719;&#21462;&#21040;&#30340;&#28040;&#24687;. &#26680;&#24515;&#20989;&#25968;&#26159;obtain(). &#36890;&#36807;&#21516;&#27493;&#26041;&#24335;
&#20174;&#28040;&#24687;&#27744;&#20013;&#21462;&#19968;&#20010;&#28040;&#24687;. &#20063;&#21487;&#20197;&#35843;&#29992;obtain(Handler h)&#26469;&#35774;&#32622;&#33719;&#21462;&#21040;&#30340;&#28040;&#24687;&#30340;
Handler.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    public static Message obtain() {
        synchronized (sPoolSync) {
            if (sPool != null) {
                Message m = sPool;
                sPool = m.next;
                m.next = null;
                m.flags = 0; // clear in-use flag
                sPoolSize--;
                return m;
            }
        }
        return new Message();
    }

    public static Message obtain(Handler h) {
        Message m = obtain();
        m.target = h;

        return m;
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#21457;&#36865;&#28040;&#24687;</span>
&#35843;&#29992;sendToTarget()&#20989;&#25968;&#35843;&#29992;Message&#30340;target&#21464;&#37327;(&#19968;&#20010;Handler)&#30340;sendMessage()&#20989;&#25968;.
&#22914;&#26524;&#27809;&#26377;&#35774;&#32622;target&#21017;&#20250;&#25253;&#38169;. sendMessage()&#20989;&#25968;&#30340;&#23454;&#29616;&#22312;Handler&#19968;&#33410;&#35762;&#36848;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    public void sendToTarget() {
        target.sendMessage(this);
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-1">* MessageQueue</span>
&#35813;&#31867;&#22522;&#20110;&#21069;&#38754;&#30340;<span class="org-link"><a href="Message">Message</a></span>&#31867;&#23454;&#29616;&#20102;&#19968;&#20010;&#28040;&#24687;&#38431;&#21015;, &#29992;&#20110;"&#39034;&#24207;"&#22788;&#29702;
&#28040;&#24687;, &#28040;&#24687;&#25353;&#29031;&#20854;&#20135;&#29983;&#26102;&#38388;&#20808;&#21518;&#25490;&#24207;.
<span class="org-level-2">** &#25554;&#20837;&#28040;&#24687;: enqueueMessage(msg, when)</span>
 &#35813;&#20989;&#25968;&#29992;&#20110;&#25554;&#20837;&#19968;&#20010;&#28040;&#24687;, &#30001;&#20110;&#28040;&#24687;&#38431;&#21015;&#25353;&#29031;&#28040;&#24687;&#26102;&#38388;when&#21319;&#24207;&#25490;&#24207;,&#25152;&#20197;
 &#26032;&#25554;&#20837;&#28040;&#24687;&#20250;&#36941;&#21382;&#21015;&#34920;, &#24182;&#25554;&#20837;&#21040;&#30456;&#24212;&#20301;&#32622;. \\
 &#19979;&#38754;&#26159;&#35813;&#20989;&#25968;&#20195;&#30721;:
<span class="org-block-begin-line"> #+BEGIN_EXAMPLE
</span><span class="org-block">     boolean enqueueMessage(Message msg, long when) {
         if (msg.target == null) {
             throw new IllegalArgumentException("Message must have a target.");
         }
         if (msg.isInUse()) {
             throw new IllegalStateException(msg + " This message is already in use.");
         }

         synchronized (this) {
             if (mQuitting) {
                 IllegalStateException e = new IllegalStateException(
                         msg.target + " sending message to a Handler on a dead thread");
                 Log.w(TAG, e.getMessage(), e);
                 msg.recycle();
                 return false;
             }

             msg.markInUse();
             msg.when = when;
             Message p = mMessages;
             boolean needWake;
             if (p == null || when == 0 || when &lt; p.when) {
                 // New head, wake up the event queue if blocked.
                 msg.next = p;
                 mMessages = msg;
                 needWake = mBlocked;
             } else {
                 // Inserted within the middle of the queue.  Usually we don't have to wake
                 // up the event queue unless there is a barrier at the head of the queue
                 // and the message is the earliest asynchronous message in the queue.
                 needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous();
                 Message prev;
                 for (;;) {
                     prev = p;
                     p = p.next;
                     if (p == null || when &lt; p.when) {
                         break;
                     }
                     if (needWake &amp;&amp; p.isAsynchronous()) {
                         needWake = false;
                     }
                 }
                 msg.next = p; // invariant: p == prev.next
                 prev.next = msg;
             }

             // We can assume mPtr != 0 because mQuitting is false.
             if (needWake) {
                 nativeWake(mPtr);
             }
         }
         return true;
     }

</span><span class="org-block-end-line"> #+END_EXAMPLE
</span> &#20989;&#25968;&#30340;&#27969;&#31243;&#22914;&#19979;:
 1. &#39318;&#20808;&#21028;&#26029;&#35813;msg&#26159;&#21542;&#26377;target&#25110;&#27491;&#22312;&#34987;&#20351;&#29992;.
 2. &#33719;&#21462;&#28040;&#24687;&#38431;&#21015;&#30340;&#38145;, &#36827;&#20837;&#21516;&#27493;&#25805;&#20316;.
    1. &#22914;&#26524;&#38431;&#21015;&#27491;&#22312;&#36864;&#20986;, &#22238;&#25910;&#26032;&#28040;&#24687;, &#24182;&#36820;&#22238;.
    2. &#21542;&#21017;, &#25554;&#20837;&#21040;&#30456;&#24212;&#20301;&#32622;
    3. &#21028;&#26029;&#26159;&#21542;&#38656;&#35201;&#21796;&#37266;, &#22914;&#26524;&#26159;&#21017;&#21796;&#37266;.
<span class="org-level-2">** &#20174;&#38431;&#21015;&#33719;&#21462;&#28040;&#24687;</span>
&#36890;&#36807;&#20989;&#25968;next()&#20174;&#38431;&#21015;&#20013;&#33719;&#21462;&#19968;&#20010;&#28040;&#24687;. &#19979;&#38754;&#26159;&#35813;&#20989;&#25968;&#20195;&#30721;, 
&#20195;&#30721;&#27969;&#31243;:
1. &#35843;&#29992;JNI&#20989;&#25968;nativePollOnce(ptr, timeout), &#35813;&#20989;&#25968;&#30340;&#31532;&#20108;&#20010;&#21442;&#25968;&#34920;&#31034;&#35201;
   &#38459;&#22622;&#30340;&#26102;&#38271;, &#22914;&#26524;&#20026;0&#21017;&#31435;&#21363;&#36820;&#22238;, &#22914;&#26524;&#20026;-1&#21017;&#19968;&#30452;&#38459;&#22622;.
2. &#35797;&#22270;&#33719;&#21462;&#19968;&#20010;&#28040;&#24687;.
   1. &#22914;&#26524;&#27809;&#26377;, &#21017;&#23558;&#19978;&#19968;&#27493;&#30340;timeout&#21464;&#37327;nextPollTimeoutMillis&#35774;&#20026;-1.
   2. &#21542;&#21017;(&#21363;&#26377;&#28040;&#24687;),
      1. &#22914;&#26524;&#28040;&#24687;&#26102;&#38388;&#22823;&#20110;&#24403;&#21069;&#26102;&#38388;(&#21363;&#28040;&#24687;&#30340;&#25191;&#34892;&#26102;&#38388;&#36824;&#26410;&#21040;&#26469;), &#21017;&#35774;&#32622;
         nextPollTimeoutMillis&#30340;&#20540;&#20026;&#24046;&#20540;.
      2. &#21542;&#21017;, &#36820;&#22238;&#28040;&#24687;.
3. &#33719;&#21462;&#28040;&#24687;&#22833;&#36133;, &#32487;&#32493;&#36208;&#24490;&#29615;&#21518;&#38754;&#30340;&#20869;&#23481;.
   1. &#22914;&#26524;&#38431;&#21015;&#27491;&#22312;&#36864;&#20986;, &#35843;&#29992;dispose()&#20989;&#25968;&#38144;&#27585;native&#30340;&#28040;&#24687;&#38431;&#21015;.&#24182;&#36820;&#22238;null.
      (&#22312;Looper&#20013;, &#36825;&#19968;&#27493;&#20250;&#23548;&#33268;looper&#36864;&#20986;).

<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">   Message next() {
        // Return here if the message loop has already quit and been disposed.
        // This can happen if the application tries to restart a looper after quit
        // which is not supported.
        final long ptr = mPtr;
        if (ptr == 0) {
            return null;
        }

        int pendingIdleHandlerCount = -1; // -1 only during first iteration
        int nextPollTimeoutMillis = 0;
        for (;;) {
            if (nextPollTimeoutMillis != 0) {
                Binder.flushPendingCommands();
            }

            nativePollOnce(ptr, nextPollTimeoutMillis);

            synchronized (this) {
                // Try to retrieve the next message.  Return if found.
                final long now = SystemClock.uptimeMillis();
                Message prevMsg = null;
                Message msg = mMessages;
                if (msg != null &amp;&amp; msg.target == null) {
                    // Stalled by a barrier.  Find the next asynchronous message in the queue.
                    do {
                        prevMsg = msg;
                        msg = msg.next;
                    } while (msg != null &amp;&amp; !msg.isAsynchronous());
                }
                if (msg != null) {
                    if (now &lt; msg.when) {
                        // Next message is not ready.  Set a timeout to wake up when it is ready.
                        nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);
                    } else {
                        // Got a message.
                        mBlocked = false;
                        if (prevMsg != null) {
                            prevMsg.next = msg.next;
                        } else {
                            mMessages = msg.next;
                        }
                        msg.next = null;
                        if (DEBUG) Log.v(TAG, "Returning message: " + msg);
                        msg.markInUse();
                        return msg;
                    }
                } else {
                    // No more messages.
                    nextPollTimeoutMillis = -1;
                }

                // Process the quit message now that all pending messages have been handled.
                if (mQuitting) {
                    dispose();
                    return null;
                }

                ...
        }
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-1">* Looper</span>
Looper&#31867;&#29992;&#20110;&#22312;&#32447;&#31243;&#20013;&#23454;&#29616;&#19968;&#20010;"&#28040;&#24687;&#24490;&#29615;"&#34892;&#20026;. 
Looper&#26377;&#19968;&#20010;<span class="org-link"><a href="MessageQueue">MessageQueue</a></span>&#31867;&#22411;&#30340;&#21464;&#37327;mQueue&#29992;&#20110;&#23384;&#20648;&#28040;&#24687;.

<span class="org-level-2">** &#20026;&#32447;&#31243;&#21021;&#22987;&#21270;&#19968;&#20010;looper</span>
Looper&#31867;&#26377;&#19968;&#20010;&#38745;&#24577;&#21464;&#37327;sThreadLocal, &#35813;&#21464;&#37327;&#26159;&#19968;&#20010;ThreadLocal
&#31867;&#22411;&#30340;&#32447;&#31243;&#31169;&#26377;&#21464;&#37327;. &#24403;&#35843;&#29992;prepare()&#20989;&#25968;&#36827;&#34892;&#21021;&#22987;&#21270;&#26102;,
&#20250;&#22312;&#20989;&#25968;&#20869;&#37096;&#29983;&#25104;&#19968;&#20010;looper&#23454;&#20363;&#24182;&#36171;&#20540;&#32473;&#35813;&#21464;&#37327;.
&#35843;&#29992; myLooper&#20989;&#25968;&#20250;&#36820;&#22238;&#36825;&#20010;&#21464;&#37327;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    private static void prepare(boolean quitAllowed) {
        if (sThreadLocal.get() != null) {
            throw new RuntimeException("Only one Looper may be created per thread");
        }
        sThreadLocal.set(new Looper(quitAllowed));
    }

    public static @Nullable Looper myLooper() {
        return sThreadLocal.get();
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span>
PS: Looper&#36824;&#26377;&#19968;&#20010;&#38745;&#24577;&#21464;&#37327;sMainLooper, &#36825;&#20010;&#21464;&#37327;&#26159;UI&#32447;&#31243;
&#30340;Looper&#24341;&#29992;, &#22312;&#24212;&#29992;&#21551;&#21160;&#26102;&#34987;&#21021;&#22987;&#21270;.
<span class="org-level-2">** loop()&#20989;&#25968;&#22788;&#29702;&#28040;&#24687;</span>
&#20989;&#25968;&#30340;&#22788;&#29702;&#22312;loop()&#20989;&#25968;&#20013;, &#35813;&#20989;&#25968;&#24314;&#31435;&#20102;&#19968;&#20010;"&#26080;&#38480;&#24490;&#29615;", 
&#27599;&#27425;&#24490;&#29615;&#37117;&#20174;&#28040;&#24687;&#38431;&#21015;&#20013;&#33719;&#21462;&#19968;&#20010;&#28040;&#24687;, &#33509;&#26080;&#28040;&#24687;&#21017;&#21487;&#33021;
&#20250;&#38459;&#22622;&#25110;&#32773;&#36864;&#20986;&#24490;&#29615;(&#20027;&#35201;&#19982;<span class="org-link"><a href="MessageQueue">MessageQueue</a></span>&#26377;&#20851;. &#19979;&#38754;&#26159;&#35813;&#20989;&#25968;&#20027;&#35201;&#20195;&#30721;:
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    public static void loop() {
        final Looper me = myLooper();
        if (me == null) {
            throw new RuntimeException("No Looper; Looper.prepare() wasn't called on this thread.");
        }
        final MessageQueue queue = me.mQueue;
        ...
        for (;;) {
            Message msg = queue.next(); // might block
            if (msg == null) {
                // No message indicates that the message queue is quitting.
                return;
            }

            ...

            msg.target.dispatchMessage(msg);

            ...

            msg.recycleUnchecked();
        }
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#20195;&#30721;&#27969;&#31243;:
1. &#35843;&#29992;queue.next()&#20989;&#25968;<span class="org-link"><a href="&#20174;&#38431;&#21015;&#33719;&#21462;&#28040;&#24687;">&#20174;&#38431;&#21015;&#33719;&#21462;&#28040;&#24687;</a></span>.
2. &#21028;&#26029;&#28040;&#24687;&#26159;&#21542;&#20026;&#31354;, &#22914;&#26524;&#20026;&#31354;&#21017;&#36864;&#20986;&#24490;&#29615;(&#32447;&#31243;&#20063;&#21487;&#33021;&#36864;&#20986;). 
   &#22240;&#20026;next()&#20989;&#25968;&#21487;&#33021;&#20250;&#23548;&#33268;&#32447;&#31243;&#38459;&#22622;. &#25152;&#20197;&#22914;&#26524;"&#34987;&#21796;&#37266;"&#36824;&#25343;&#21040;&#31354;&#28040;&#24687;,
   &#26377;&#21487;&#33021;&#26159;&#21035;&#30340;&#32447;&#31243;&#35843;&#29992;&#20102;quit()&#20989;&#25968;.
3. &#35843;&#29992;msg&#30340;target&#21464;&#37327;(&#21363;Handler)&#30340;dispatchMessage()&#20989;&#25968;.
4. &#35843;&#29992;<span class="org-link"><a href="Message">Message</a></span>&#30340;recycleUnchecked()&#20989;&#25968;&#22238;&#25910;&#28040;&#24687;.
<span class="org-level-1">* Handler</span>
&#22312;&#19968;&#33324;&#30340;APP&#24320;&#21457;&#20013;, &#37117;&#26159;&#36890;&#36807;handler&#36827;&#34892;&#28040;&#24687;&#30340;&#21457;&#36865;&#25110;
&#22788;&#29702;. &#36825;&#37324;&#26159;&#20960;&#20010;&#20027;&#35201;&#21151;&#33021;&#30340;&#20195;&#30721;&#31508;&#35760;.
<span class="org-level-2">** &#21019;&#24314;handler</span>
Handler&#30340;&#26500;&#36896;&#20989;&#25968;&#26377;&#22810;&#20010;, &#22522;&#26412;&#26368;&#21518;&#37117;&#35843;&#21040;&#19979;&#38754;&#20004;&#20010;&#20989;&#25968;&#20043;&#19968;:
1. Handler(callback, async).
   &#31532;&#19968;&#20010;&#21442;&#25968;callback&#30340;&#29992;&#20110;, &#22914;&#26524;&#19981;&#24819;&#33258;&#24049;&#20889;&#19968;&#20010;Handler&#30340;&#23376;&#31867;
   (Handler&#30340;&#36890;&#24120;&#29992;&#27861;), &#21487;&#20197;&#20256;&#20837;&#19968;&#20010;callback&#21442;&#25968;&#29992;&#20110;&#22788;&#29702;&#28040;&#24687;.
   &#31532;&#20108;&#20010;&#21442;&#25968;async&#26631;&#24535;&#28040;&#24687;&#26159;&#21542;&#35201;&#25353;&#26102;&#38388;&#25490;&#24207;.
   &#35813;&#20989;&#25968;&#20250;&#21435;&#25343;&#21435;&#24403;&#21069;&#32447;&#31243;&#30340;<span class="org-link"><a href="Looper">Looper</a></span>, &#22914;&#26524;&#27809;&#26377;&#21017;&#25253;&#38169;.
<span class="org-block-begin-line">   #+BEGIN_EXAMPLE
</span><span class="org-block">       public Handler(Callback callback, boolean async) {
        if (FIND_POTENTIAL_LEAKS) {
            final Class&lt;? extends Handler&gt; klass = getClass();
            if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp;
                    (klass.getModifiers() &amp; Modifier.STATIC) == 0) {
                Log.w(TAG, "The following Handler class should be static or leaks might occur: " +
                    klass.getCanonicalName());
            }
        }

        mLooper = Looper.myLooper();
        if (mLooper == null) {
            throw new RuntimeException(
                "Can't create handler inside thread that has not called Looper.prepare()");
        }
        mQueue = mLooper.mQueue;
        mCallback = callback;
        mAsynchronous = async;
    }
</span><span class="org-block-end-line">   #+END_EXAMPLE
</span>
2. Handler(looper, callback, async).
   &#31532;&#19968;&#20010;&#21442;&#25968;looper&#26159;&#26174;&#31034;&#30340;&#20256;&#20837;&#19968;&#20010;looper&#21442;&#25968;&#32473;handler&#30340;&#26500;&#36896;&#20989;&#25968;.
   &#36825;&#26679;&#21363;&#20351;&#24403;&#21069;&#32447;&#31243;&#27809;&#26377;looper&#20063;&#21487;&#20197;.
<span class="org-level-2">** &#33719;&#21462;&#19968;&#20010;&#28040;&#24687;</span>
&#35843;&#29992;obtainMessage()&#21487;&#20197;&#33719;&#21462;&#19968;&#20010;&#28040;&#24687;, &#20989;&#25968;&#20869;&#37096;&#36890;&#36807;
&#35843;&#29992;<span class="org-link"><a href="Message">Message</a></span>&#30340;obtain()&#20989;&#25968;&#23454;&#29616;.
<span class="org-level-2">** &#21457;&#36865;&#28040;&#24687;</span>
Handler&#30340;&#21457;&#36865;&#28040;&#24687;&#30456;&#20851;&#30340;&#20989;&#25968;&#20063;&#26377;&#22810;&#20010;, &#22522;&#26412;&#37117;&#26159;&#20808;&#35745;&#31639;&#35813;message
&#30340;&#25191;&#34892;&#26102;&#38388;, &#28982;&#21518;&#35843;&#29992;sendMessageAtTime()&#20989;&#25968;. &#35813;&#20989;&#25968;&#20869;&#37096;&#35843;&#29992;&#20102; 
enqueueMessage()&#20989;&#25968;, &#26368;&#32456;&#35843;&#29992;&#21040;&#20102;<span class="org-link"><a href="MessageQueue">MessageQueue</a></span>&#30340;
enqueueMessage()&#20989;&#25968;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    public boolean sendMessageAtTime(Message msg, long uptimeMillis) {
        MessageQueue queue = mQueue;
        if (queue == null) {
            RuntimeException e = new RuntimeException(
                    this + " sendMessageAtTime() called with no mQueue");
            Log.w("Looper", e.getMessage(), e);
            return false;
        }
        return enqueueMessage(queue, msg, uptimeMillis);
    }
    private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
        msg.target = this;
        if (mAsynchronous) {
            msg.setAsynchronous(true);
        }
        return queue.enqueueMessage(msg, uptimeMillis);
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#21457;&#36865;runnable</span>
post&#31995;&#21015;&#20989;&#25968;&#29992;&#20110;&#21457;&#36865;&#19968;&#20010;"Runnable"&#28040;&#24687;, &#35813;runnable&#20250;&#34987;&#23384;&#20837;
&#28040;&#24687;&#30340;callback&#21464;&#37327;. &#22312;<span class="org-link"><a href="Looper">Looper</a></span>&#20570;&#28040;&#24687;&#20998;&#21457;&#26102;, &#20250;&#22238;&#35843;&#21040;Handler&#30340;
dispatchMessage()&#20989;&#25968;&#26469;&#22788;&#29702;callback.&#20195;&#30721;&#22914;&#19979;:
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    public final boolean post(Runnable r)
    {
       return  sendMessageDelayed(getPostMessage(r), 0);
    }

    public final boolean sendMessageDelayed(Message msg, long delayMillis)
    {
        if (delayMillis &lt; 0) {
            delayMillis = 0;
        }
        return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);
    }
    
    //called from looper
    public void dispatchMessage(Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            handleMessage(msg);
        }
    }
    private static void handleCallback(Message message) {
        message.callback.run();
    }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span></pre>
  </body>
</html>
