<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.43 in css mode. -->
<html>
  <head>
    <title>Android-logcat.org</title>
    <style type="text/css">
    <!--
      body {
        color: #DCDCCC;
        background-color: #3F3F3F;
      }
      .italic {
        /* italic */
        font-style: italic;
      }
      .org-block {
        /* org-block */
        color: #009acd;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #7F9F7F;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #7F9F7F;
      }
      .org-document-info {
        /* org-document-info */
        color: #afeeee;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-weight: bold;
      }
      .org-footnote {
        /* org-footnote */
        color: #93E0E3;
        text-decoration: underline;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #DFAF8F;
        font-size: 130%;
        text-decoration: overline;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #7F9F7F;
      }
      .org-table {
        /* org-table */
        color: #9FC59F;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+OPTIONS: ^:nil</span>
<span class="org-meta-line">#+OPTIONS: toc:t H:2</span>
<span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">Zhengchao Xu
</span><span class="org-document-info-keyword">#+EMAIL:</span> <span class="org-document-info">xuzhengchaojob@gmail.com
</span><span class="org-document-info-keyword">#+TITLE:</span> <span class="org-document-title">Android Logcat
</span>
&#36825;&#31687;&#25991;&#31456;&#20171;&#32461;android&#31995;&#32479;&#20013;&#24405;log&#30340;&#24037;&#20855; logcat.

Android &#31995;&#32479;&#25552;&#20379;&#20102;&#19968;&#25972;&#22871;&#30340;API&#20379;Java&#23618;&#21644;Native&#23618;&#30340;&#31243;&#24207;&#20889;log,&#20197;&#26041;&#20415;&#35843;&#35797;&#21450;&#22312;&#31995;&#32479;&#20986;&#38382;&#39064;&#30340;&#26102;&#20505;&#26377;&#25454;&#21487;&#26597;. 
&#32780;logcat&#26159;&#25226;&#36825;&#20123;&#25235;log&#30340;&#24037;&#20855;,&#21487;&#20197;&#36890;&#36807;logcat&#25226;log&#26174;&#31034;&#21040;&#26631;&#20934;&#36755;&#20986;&#25110;&#25991;&#20214;&#20013;,&#21516;&#26102;&#36824;&#21487;&#20197;&#23545;log&#36827;&#34892;&#36807;&#28388;. &#35774;&#23450;log level&#21450;&#21482;&#35835;&#21462;&#25351;&#23450;module&#30340;log. logcat &#30340;&#35814;&#32454;&#29992;&#27861;&#21487;&#20197;&#22312;&#25163;&#26426;&#20013;&#36755;&#20837;"logcat --help" &#21629;&#20196;&#26597;&#30475;.

&#26412;&#25991;&#20027;&#35201;&#23545;logcat&#30340;&#28304;&#30721;&#36827;&#34892;&#20998;&#26512;,&#20174;main&#20989;&#25968;&#24320;&#22987;.&#20174;main&#20989;&#25968;&#24320;&#22987;&#36935;&#21040;&#30340;&#31532;&#19968;&#20010;&#20989;&#25968;&#35843;&#29992;&#26159;.

    g_logformat = android_log_format_new();

&#30475;&#19979;&#36825;&#20010;&#20989;&#25968;&#30340;&#23450;&#20041;:
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        /* android_log_format_new()*/
        AndroidLogFormat *android_log_format_new()
        {
            AndroidLogFormat *p_ret;
        
            p_ret = calloc(1, sizeof(AndroidLogFormat));
        
            p_ret-&gt;global_pri = ANDROID_LOG_VERBOSE;
            p_ret-&gt;format = FORMAT_BRIEF;
        
            return p_ret;
        }
        
</span><span class="org-block-end-line">#+END_EXAMPLE   
</span>&#36825;&#20010;&#20989;&#25968;&#36890;&#36807;malloc&#29983;&#25104;&#19968;&#20010; AndroidLogFormat &#30340;&#32467;&#26500;&#20307;,&#24182;&#23558;&#32467;&#26500;&#20307;&#30340;&#25104;&#21592;&#21464;&#37327; 'global_pri' &#21644; 'format' &#35774;&#32622;.&#20808;&#30465;&#30053;&#36825;&#20010;&#32467;&#26500;&#20307;&#30340;&#23454;&#29616;,&#32487;&#32493;&#30475;main &#20989;&#25968;&#30340;&#20195;&#30721;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        /* main()*/
    if (argc == 2 &amp;&amp; 0 == strcmp(argv[1], "--test")) {
        logprint_run_tests();
        exit(0);
    }

</span><span class="org-block-end-line">#+END_EXAMPLE   
</span><span class="org-level-1">* test &#21442;&#25968;</span>

&#22914;&#26524;logcat&#21482;&#26377;&#19968;&#20010;&#21442;&#25968;"--test",&#21017;&#25191;&#34892;logprint_run_tests()&#20989;&#25968;,&#20174;&#20195;&#30721;&#26469;&#30475;,&#36825;&#20010;&#20989;&#25968;&#20027;&#35201;&#26159;&#27979;&#35797;logcat&#30340;&#21151;&#33021;&#30340;.

        <span class="italic">/* logprint_run_tests()*/</span>
    p_format = android_log_format_new();
    fprintf(stderr, "running tests\n");
    tag = "random";
    android_log_addFilterRule(p_format,"*:i");

&#36825;&#20010;&#20989;&#25968;&#24320;&#22987;&#20063;call&#20102;&#19968;&#27425; android_log_format_new()&#20998;&#37197;&#20102;&#19968;&#20010;&#32467;&#26500;&#20307;.&#24182;&#35774;&#32622;&#20102;tag&#21464;&#37327;,tag&#26159;&#27599;&#20010;module&#22312;&#25171;log&#26102;&#37117;&#38656;&#35201;&#35774;&#32622;&#19968;&#20010;tag,&#21487;&#20197;&#36890;&#36807;tag&#29992;&#26469;&#26631;&#24535;&#26159;&#35813;module&#36755;&#20986;&#30340;log. &#25509;&#30528;call&#20989;&#25968; android_log_addFilterRule(), &#35774;&#32622;logcat&#30340;&#36807;&#28388;&#26426;&#21046;.

        <span class="italic">/* android_log_addFilterRule() */</span>
        android_LogPriority pri = ANDROID_LOG_DEFAULT;
        tagNameLength = strcspn(filterExpression, ":");
    if(filterExpression[tagNameLength] == ':') {
        pri = filterCharToPri(filterExpression[tagNameLength+1]);

        if (pri == ANDROID_LOG_UNKNOWN) {
            goto error;
        }
    }

&#35813;&#20989;&#25968;&#35774;&#32622;pri&#21464;&#37327;&#30340;&#20540;&#20026; ANDROID_LOG_DEFAULT, &#36825;&#20010;&#20540;&#34987;&#23450;&#20041;&#22312;&#19968;&#20010;enum&#20013;,&#22914;&#26524;log pririoty&#34987;&#35774;&#20026; ANDROID_LOG_DEFAULT, &#21017;&#34920;&#31034;&#36755;&#20986;&#25152;&#26377;&#31561;&#32423;&#30340;log.&#25509;&#30528;&#33719;&#24471;filter&#30340;tag&#30340;&#38271;&#24230;,&#26681;&#25454;&#21069;&#38754;&#30340;&#21442;&#25968;,"*:i"&#30340;&#36820;&#22238;&#32467;&#26524;&#26159;1, &#25509;&#30528;&#35843;&#29992;filterCharToPri(),&#24182;&#20256;&#20837;&#21442;&#25968;"i"
. &#36825;&#20010;&#20989;&#25968;&#25226;&#20256;&#20837;&#30340;&#23383;&#31526;&#24418;&#24335;&#30340;log level &#36716;&#25442;&#20026;&#25968;&#23383;level,&#36825;&#20123;level&#21644; ANDROID_LOG_DEFAULT&#19968;&#36215;&#23450;&#20041;&#22312;enum&#20013;.

    } else if (c == 'i') {
        pri = ANDROID_LOG_INFO;

        <span class="italic">/* define */</span>
        enum  {
            ANDROID_LOG_UNKNOWN = 0,
            ANDROID_LOG_DEFAULT,    <span class="italic">/* only for SetMinPriority() */</span>
        
            ANDROID_LOG_VERBOSE,
            ANDROID_LOG_DEBUG,
            ANDROID_LOG_INFO,
            ANDROID_LOG_WARN,
            ANDROID_LOG_ERROR,
            ANDROID_LOG_FATAL,
        
            ANDROID_LOG_SILENT,     <span class="italic">/* only for SetMinPriority(); must be last */</span>
        
&#25509;&#19979;&#26469;&#21028;&#26029;&#26159;&#21542;&#26377;&#35774;&#32622;&#20840;&#23616;&#30340;log level,&#21363;&#20256;&#20837;&#30340;filter&#20013;&#26159;&#21542;&#21253;&#21547;"*:x"&#30340;&#23383;&#31526;&#20018;,&#22914;&#26524;&#26159;&#30340;&#35805;,&#23601;&#35774;&#32622;&#19968;&#20010;&#20840;&#23616;&#24615;&#30340;log level

        <span class="italic">/* android_log_addFilterRule() */</span>
    if(0 == strncmp("*", filterExpression, tagNameLength)) {
        if (pri == ANDROID_LOG_DEFAULT) {
            pri = ANDROID_LOG_DEBUG;
        }
        p_format-&gt;global_pri = pri;

&#36825;&#26679;,runtest()&#20989;&#25968;&#30340;filter&#35774;&#32622;&#23601;&#23436;&#25104;&#20102;,&#21097;&#19979;&#37117;&#26159;&#19968;&#20123;&#22522;&#26412;&#30340;&#26816;&#26597;&#35821;&#21477;&#26816;&#26597;&#35774;&#32622;&#26377;&#27809;&#26377;&#25104;&#21151;.

            assert (ANDROID_LOG_INFO == filterPriForTag(p_format, "random"));

&#36825;&#26465;&#35821;&#21477;&#26816;&#26597;tag "random"&#30340;priority&#26159;&#21542;&#26159;ANDROID_LOG_INFO,&#30475;&#19979; filterPriForTag()&#20989;&#25968;&#23454;&#29616;

        static android_LogPriority filterPriForTag(
                AndroidLogFormat *p_format, const char *tag)
        {
            FilterInfo *p_curFilter;
            for (p_curFilter = p_format-&gt;filters
                    ; p_curFilter != NULL
                    ; p_curFilter = p_curFilter-&gt;p_next
            ) {
                if (0 == strcmp(tag, p_curFilter-&gt;mTag)) {
                    if (p_curFilter-&gt;mPri == ANDROID_LOG_DEFAULT) {
                        return p_format-&gt;global_pri;
                    } else {
                        return p_curFilter-&gt;mPri;
                    }
                }
            }
        
            return p_format-&gt;global_pri;
        }

&#36825;&#27573;code&#24456;&#30452;&#35266;,&#39318;&#20808;&#36941;&#21382;p_format&#30340;filter,&#26816;&#26597;&#26377;&#27809;&#26377;&#35774;&#32622;tag&#30340;priority, &#22914;&#26524;&#27809;&#26377;&#25214;&#21040;,&#23601;&#36820;&#22238;&#20840;&#23616;&#30340;log level. &#36824;&#26377;&#21478;&#19968;&#20010;&#38656;&#35201;&#26816;&#26597;&#30340;&#22320;&#26041;

    assert(android_log_shouldPrintLine(p_format, tag, ANDROID_LOG_DEBUG) == 0);

&#22312;android&#20013;&#27599;&#26465;log&#37117;&#23545;&#24212;&#35201;&#19968;&#20010;priority,&#36825;&#20010;&#20989;&#25968;&#26816;&#26597;&#30456;&#24212;tag&#30340;&#36825;&#26465;log&#26159;&#21542;&#24212;&#35813;&#25171;&#21360;&#20986;&#26469;.
        
        int android_log_shouldPrintLine (
                AndroidLogFormat *p_format, const char *tag, android_LogPriority pri)
        {
            return pri &gt;= filterPriForTag(p_format, tag);
        }

&#36890;&#36807;filterPriForTag()&#20989;&#25968;&#26597;&#25214;&#35813;tag&#30340;priority,&#28982;&#21518;&#36319;&#20256;&#20837;&#30340;level&#20570;&#27604;&#36739;,&#21028;&#26029;&#26159;&#21542;&#38656;&#35201;&#25171;&#21360;&#35813;tag&#35813;level&#32423;&#21035;&#30340;log.

&#21516;&#26102;,&#21487;&#20197;&#36890;&#36807; android_log_addFilterString()&#35774;&#23450;&#22810;&#20010;log filter.

    err = android_log_addFilterString(p_format, "*:s random:d ");

        int android_log_addFilterString(AndroidLogFormat *p_format,
                const char *filterString)
        {
            // Yes, I'm using strsep
            while (NULL != (p_ret = strsep(&amp;p_cur, " \t,"))) {
                // ignore whitespace-only entries
                if(p_ret<span class="org-footnote">[0]</span> != '\0') {
                    err = android_log_addFilterRule(p_format, p_ret);
                }
            }
        ......  
        }

android_log_addFilterString()&#20250;&#24490;&#29615;&#36941;&#21382;&#20256;&#20837;&#30340;filter string,&#24182;&#23558;&#20854;&#28155;&#21152;&#21040;filter &#38142;&#34920;&#20013;.
ok, "--test" &#21442;&#25968;&#21040;&#36825;&#37324;&#23601;&#35762;&#23436;&#20102;.

<span class="org-level-1">* "-s" &#21442;&#25968;</span>

&#23558;&#20840;&#23616;&#30340;log level &#35774;&#20026; ANDROID_LOG_SILENT, &#21363;&#19981;&#36755;&#20986;&#25152;&#26377;level&#30340;log

        android_log_addFilterRule(g_logformat, "*:s");

<span class="org-level-1">* "-c" &#21442;&#25968;</span>

&#35813;&#21442;&#25968;&#21487;&#20197;&#23558;log device&#20013;&#30340;log&#21024;&#38500;.

        case 'c':
       clearLog = 1;
       mode = O_WRONLY;
    break;

        if (clearLog) {
            int ret;
            ret = android::clearLog(dev-&gt;fd);

&#30475;&#19979;clearLog&#20989;&#25968;

        static int clearLog(int logfd)
        {
            return ioctl(logfd, LOGGER_FLUSH_LOG);
        }

&#35813;&#20989;&#25968;&#21521;driver&#23618;&#19979;&#21457; LOGGER_FLUSH_LOG &#21629;&#20196;,&#21578;&#35785;logger device&#30340;driver&#23558;logger&#20013;&#30340;log&#28165;&#38500;,&#20851;&#20110;logger device&#30340;&#23454;&#29616;&#22312;&#21518;&#38754;&#20250;&#35762;&#21040;.

<span class="org-level-1">* "-d" "-t N" &#21442;&#25968;</span>

&#36825;&#20004;&#20010;&#21442;&#25968;&#37117;&#20250;&#23558;g_nonblock&#21464;&#37327;&#35774;&#20026;true,&#34920;&#31034;&#25226;logger&#37324;&#30340;log&#35835;&#23436;&#23601;&#20250;&#31435;&#21051;&#36864;&#20986;,&#32780;&#19981;&#20250;&#31561;&#24453;&#26032;log&#30340;&#20889;&#20837;. &#21516;&#26102;"-t"&#21442;&#25968;&#21518;&#38754;&#36824;&#35201;&#36319;&#30528;&#19968;&#20010;&#20540;N,&#34920;&#31034;&#21482;&#35835;&#26368;&#36817;&#30340;N&#26465;log.

<span class="org-level-1">* "-g" &#21442;&#25968;</span>

&#32473;driver&#21457;&#36865;LOGGER_GET_LOG_BUF_SIZE, &#33719;&#24471;logger device&#30340;&#22823;&#23567;.

<span class="org-level-1">* "-b device" &#21442;&#25968;</span>

&#25351;&#23450;&#35201;&#20174;&#21738;&#20010;buffer&#20013;&#35835;log, "-b"&#21487;&#20197;&#20351;&#29992;&#22810;&#27425;,&#20363;&#22914;" -b main -b radio"

<span class="org-level-1">* "-B" &#21442;&#25968;</span>

&#20197;&#20108;&#36827;&#21046;&#26041;&#24335;&#25171;&#21360;log(&#30446;&#21069;&#40664;&#35748;&#20250;&#23545;log&#36827;&#34892;&#35299;&#26512;,&#20197;&#23383;&#31526;&#20018;&#24418;&#24335;&#25171;&#21360;)

<span class="org-level-1">* "-f file" &#21442;&#25968;</span>

&#23558;log &#36755;&#20986;&#21040;&#25351;&#23450;&#25991;&#20214; file

<span class="org-level-1">* "-r size" &#21442;&#25968;</span>

&#35774;&#23450;rotate size&#22823;&#23567;,rotate size &#30340;&#21547;&#20041;&#26159;&#27599;&#31181;log &#26368;&#22810;&#21482;&#26377; size &#22823;&#23567;. &#24405;&#28385;&#21518;&#26087;log&#20250;&#34987;&#35206;&#30422;

<span class="org-level-1">* "-n num" &#21442;&#25968;</span>

&#35774;&#23450;&#27599;&#31181;log&#26368;&#22823;&#30340;log file&#25968;&#37327;,&#27599;&#20010;file&#30340;&#22823;&#23567;&#20026; rotate_size/num

<span class="org-level-1">* "-v format" &#21442;&#25968;</span>

&#35774;&#23450;&#36755;&#20986;&#30340;log &#26684;&#24335;

        err = setLogFormat (optarg);
        static int setLogFormat(const char * formatString)
        {
            static AndroidLogPrintFormat format;
        
            format = android_log_formatFromString(formatString);
            android_log_setPrintFormat(g_logformat, format);

            return 0;
        }

        AndroidLogPrintFormat android_log_formatFromString(const char * formatString)
        {
            static AndroidLogPrintFormat format;
        
            if (strcmp(formatString, "brief") == 0) format = FORMAT_BRIEF;
            else if (strcmp(formatString, "process") == 0) format = FORMAT_PROCESS;
            else if (strcmp(formatString, "tag") == 0) format = FORMAT_TAG;
            else if (strcmp(formatString, "thread") == 0) format = FORMAT_THREAD;
            else if (strcmp(formatString, "raw") == 0) format = FORMAT_RAW;
            else if (strcmp(formatString, "time") == 0) format = FORMAT_TIME;
            else if (strcmp(formatString, "threadtime") == 0) format = FORMAT_THREADTIME;
            else if (strcmp(formatString, "long") == 0) format = FORMAT_LONG;
            else format = FORMAT_OFF;
        
            return format;
        }

&#31532;&#19968;&#20010;&#20989;&#25968;&#25226;&#23383;&#31526;&#20018;&#24418;&#24335;&#30340;format&#36716;&#25442;&#25104;&#25972;&#24418;&#34920;&#31034;,&#31532;&#20108;&#20010;&#21442;&#25968;&#25226;&#36716;&#25442;&#21518;&#30340;format&#35774;&#32622;&#21040;&#20840;&#23616;&#21464;&#37327;g_logformat&#20013;
        

OK, &#21040;&#27492;&#20026;&#27490;,&#21442;&#25968;&#37096;&#20998;&#23601;&#35299;&#26512;&#23436;&#27605;.&#25509;&#30528;&#25191;&#34892;&#19979;&#38754;&#30340;&#20195;&#30721;


&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;"-b"&#21442;&#25968;&#30340;&#35805;,&#20250;&#40664;&#35748;&#25171;&#24320; "main" &#21644; "system" &#20004;&#20010;logger device

    if (!devices) {
        devices = new log_device_t(strdup("<span class="italic">/dev/</span>"LOGGER_LOG_MAIN), false, 'm');
        android::g_devCount = 1;
        int accessmode =
                  (mode &amp; O_RDONLY) ? R_OK : 0
                <span class="org-table">| (mode &amp; O_WRONLY) ? W_OK : 0;</span>
        if (0 == access("<span class="italic">/dev/</span>"LOGGER_LOG_SYSTEM, accessmode)) {
            devices-&gt;next = new log_device_t(strdup("<span class="italic">/dev/</span>"LOGGER_LOG_SYSTEM), false, 's');
            android::g_devCount++;
        }
    }

&#25509;&#19979;&#26469;&#26159;&#35774;&#23450;&#36755;&#20986;,&#22914;&#26524;&#27809;&#26377;&#25351;&#23450;"-f file"&#21442;&#25968;,&#40664;&#35748;&#36755;&#20986;&#21040;&#26631;&#20934;&#36755;&#20986;,&#21542;&#21017;&#25171;&#24320;file &#25991;&#20214;.

        static void setupOutput()
        {
        
            if (g_outputFileName == NULL) {
                g_outFD = STDOUT_FILENO;
            } else {
                struct stat statbuf;
                g_outFD = openLogFile (g_outputFileName);
                fstat(g_outFD, &amp;statbuf);
                g_outByteCount = statbuf.st_size;
            }
        }
        
&#22914;&#26524;&#26377;&#35774;&#23450;log filter&#30340;&#35805;,&#20250;&#35299;&#26512;&#23383;&#31526;&#20018;&#24182;&#21152;&#20837;&#21040;g_logformat&#30340;filter&#38142;&#34920;&#20013;       

        for (int i = optind ; i &lt; argc ; i++) {
        err = android_log_addFilterString(g_logformat, argv[i]);

&#25509;&#19979;&#26469;&#20250;&#25171;&#24320;logger device,&#28982;&#21518;&#23601;&#26159;&#35835;log&#20102;.

    android::readLogLines(devices);

<span class="org-level-1">* &#35835;log</span>

readLogLines()&#20989;&#25968;&#36890;&#36807;&#19968;&#20010;while loop&#19981;&#20572;&#30340;&#20174;kernel &#23618;&#30340;logger device&#20013;&#35835;&#21462;log

    while (1) {
        do {
            timeval timeout = { 0, 5000 <span class="italic">/* 5ms */</span> }; // If we oversleep it's ok, i.e. ignore EINTR.
            FD_ZERO(&amp;readset);
            for (dev=devices; dev; dev = dev-&gt;next) {
                FD_SET(dev-&gt;fd, &amp;readset);
            }
            result = select(max + 1, &amp;readset, NULL, NULL, sleep ? NULL : &amp;timeout);
        } while (result == -1 &amp;&amp; errno == EINTR);

&#36825;&#37324;&#26377;&#35774;&#19968;&#20010;timeout,&#26368;&#24320;&#22987;&#36825;&#20010;&#20540;&#20026;false,&#26631;&#24535;&#19968;&#30452;&#31561;&#24453;&#26377;log&#20135;&#29983;. &#22914;&#26524;&#20026;true, &#34920;&#31034;&#36825;&#27573;&#26102;&#38388;&#20869;&#27809;&#26377;&#26032;&#30340;log&#20135;&#29983;,&#21017;&#20250;&#25226;&#20197;&#21450;&#35835;&#20986;&#26469;&#30340;log&#20840;&#37096;flush&#21040;&#36755;&#20986;.

&#22914;&#26524;select()&#36820;&#22238;,&#20250;&#26816;&#26597;&#26159;&#21542;&#26377;logger device&#21487;&#35835;,&#24182;&#23581;&#35797;&#20174;device&#20013;&#35835;&#21462;&#19968;&#26465;log.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        if (result &gt;= 0) {
            for (dev=devices; dev; dev = dev-&gt;next) {
                if (FD_ISSET(dev-&gt;fd, &amp;readset)) {
                    queued_entry_t* entry = new queued_entry_t();
                    ret = read(dev-&gt;fd, entry-&gt;buf, LOGGER_ENTRY_MAX_LEN);

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>logger device read() &#30340;&#23454;&#29616;&#26159;&#27599;&#27425;&#35835;&#21462;&#19968;&#26465;logger_entry, &#24182;&#23384;&#25918;&#21040;&#32467;&#26500;&#20307;queued_entry_t &#30340;&#25104;&#21592;&#21464;&#37327; buf &#20013;,queued_entry_t &#30340;&#23450;&#20041;&#22914;&#19979;:
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        struct queued_entry_t {
            union {
                unsigned char buf[LOGGER_ENTRY_MAX_LEN + 1] __attribute__((aligned(4)));
                struct logger_entry entry __attribute__((aligned(4)));
            };
            queued_entry_t* next;
        
            queued_entry_t() {
                next = NULL;
            }
        };

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#21487;&#20197;&#30475;&#21040;buf&#21644;logger_entry&#34987;&#23450;&#20041;&#25104;union&#32467;&#26500;,&#25152;&#20197;&#35835;&#21040;buffer&#30340;&#20869;&#23481;&#21516;&#26102;&#26159;&#19968;&#26465;logger_entry. &#35813;&#32467;&#26500;&#20307;&#30340;&#23450;&#20041;&#22914;&#19979;
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        struct logger_entry {
            uint16_t    len;    /* length of the payload */
            uint16_t    __pad;  /* no matter what, we get 2 bytes of padding */
            int32_t     pid;    /* generating process's pid */
            int32_t     tid;    /* generating process's tid */
            int32_t     sec;    /* seconds since Epoch */
            int32_t     nsec;   /* nanoseconds */
            char        msg[0]; /* the entry's payload */
        };

</span><span class="org-block-end-line">#+END_EXAMPLE   
</span>&#31532;&#19968;&#20010;&#21464;&#37327;len&#26159;&#23383;&#31526;&#20018;msg&#30340;&#38271;&#24230;,&#25152;&#20197;read()&#20989;&#25968;&#36820;&#22238;&#21518;&#20250;&#23545;&#36820;&#22238;&#20540;&#21644;len&#30340;&#20540;&#20570;&#27604;&#36739;,&#22914;&#26524;&#19981;&#30456;&#31561;,&#34920;&#31034;&#35835;&#30340;&#25968;&#25454;&#26377;&#38169;&#35823;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        else if (entry-&gt;entry.len != ret - sizeof(struct logger_entry)) {
                fprintf(stderr, "read: unexpected length. Expected %d, got %d\n",
                entry-&gt;entry.len, ret - sizeof(struct logger_entry));
                exit(EXIT_FAILURE);
        }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#25509;&#30528;&#20250;call device&#21464;&#37327;dev&#30340;enqueue()&#20989;&#25968;&#25226;&#21018;&#35835;&#20986;&#26469;&#30340;log&#25554;&#20837;&#21040;dev&#30340;entry list&#20013;,&#24182;&#25490;&#24207;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
    void enqueue(queued_entry_t* entry) {
        if (this-&gt;queue == NULL) {
            this-&gt;queue = entry;
        } else {
            queued_entry_t** e = &amp;this-&gt;queue;
            while (*e &amp;&amp; cmp(entry, *e) &gt;= 0) {
                e = &amp;((*e)-&gt;next);
            }
            entry-&gt;next = *e;
            *e = entry;
        }
    }
        
        static int cmp(queued_entry_t* a, queued_entry_t* b) {
            int n = a-&gt;entry.sec - b-&gt;entry.sec;
            if (n != 0) {
                return n;
            }
            return a-&gt;entry.nsec - b-&gt;entry.nsec;
        }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#25554;&#20837;&#30340;&#31639;&#27861;&#26159;&#20174;&#38142;&#34920;&#22836;&#24320;&#22987;&#24050;&#26377;entry&#19982;&#26032;entry&#30340;&#26102;&#38388;&#25139;,&#22914;&#26524;&#26032;entry&#30340;&#20135;&#29983;&#26102;&#38388;&#27604;&#36739;&#26202;,&#23601;&#32487;&#32493;&#19982;&#19979;&#19968;&#20010;entry&#27604;&#36739;. &#20854;&#23454;&#29702;&#35770;&#19978;&#35762;,&#26202;&#21040;&#26469;&#30340;log&#24635;&#26159;&#20135;&#29983;&#26102;&#38388;&#26202;&#30340;log,&#25152;&#20197;&#36825;&#31181;&#27604;&#36739;&#30340;&#27604;&#36739;&#27425;&#25968;&#19968;&#33324;&#35201;&#22823;&#20110;&#20174;&#23614;&#37096;&#24320;&#22987;&#27604;&#36739;. &#21478;&#22806;&#20540;&#24471;&#19968;&#25552;&#30340;&#26159;&#27604;&#36739;&#31639;&#27861;&#37319;&#29992;&#20102;&#25351;&#38024;&#30340;&#25351;&#38024;,&#27604;&#36739;&#31616;&#27905;,&#36991;&#20813;&#25554;&#20837;&#26102;&#38142;&#34920;&#22836;&#30340;&#21028;&#26029;. Linus&#22823;&#23158;&#26366;&#32463;&#22312;&#19968;&#27425;&#35775;&#35848;&#20013;&#35828;&#36947;"&#36825;&#25165;&#26159;&#25351;&#38024;&#30340;&#30495;&#27491;&#29992;&#27861;".......

&#25509;&#19979;&#26469;&#20250;&#25171;&#21360;log,&#38656;&#35201;&#35828;&#26126;&#30340;&#26159;&#27809;&#35835;&#20986;&#19968;&#27425;log&#23601;&#20250;&#21028;&#26029;&#26159;&#21542;&#38656;&#35201;&#25171;&#21360;log. &#22914;&#26524;&#26159;select&#36229;&#26102;&#36820;&#22238;,&#20250;&#25171;&#21360;&#25152;&#26377;"&#38656;&#35201;"&#25171;&#21360;&#30340;log(&#36825;&#37324;&#21152;&#25152;&#26377;&#26159;&#22240;&#20026;&#22914;&#26524;&#20351;&#29992;"t"&#21442;&#25968;&#30340;&#35805;,&#21482;&#20250;&#25171;&#21360;&#26368;&#26032;&#30340;&#20960;&#26465;log),&#21542;&#21017;,&#20250;&#25171;&#21360;&#38500;&#26368;&#21518;&#19968;&#26465;log&#20197;&#22806;&#30340;&#25152;&#26377;log,&#21097;&#19968;&#26465;log&#26159;&#20026;&#20102;&#19979;&#27425;&#26102;&#38388;&#25139;&#30340;&#27604;&#36739;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        while (g_tail_lines == 0 || queued_lines &gt; g_tail_lines) {
        chooseFirst(devices, &amp;dev);
        if (dev == NULL || dev-&gt;queue-&gt;next == NULL) {
                break;
        }
        if (g_tail_lines == 0) {
                printNextEntry(dev);
        } else {
            skipNextEntry(dev);
        }
        --queued_lines;

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>chooseFirst()&#20989;&#25968;&#20250;&#25226;device&#38142;&#34920;&#20013;&#21253;&#21547;&#26368;&#26032;log&#30340;device&#36873;&#20986;&#26469;,&#36825;&#26679;&#23545;&#20110;&#22810;&#31181;&#31867;&#22411;&#30340;log&#36755;&#20986;&#21040;&#21516;&#19968;&#20010;&#25991;&#20214;&#30340;case,&#21487;&#20197;&#20445;&#35777;log&#25353;&#26102;&#38388;&#25490;&#24207;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        static void chooseFirst(log_device_t* dev, log_device_t** firstdev) {
            for (*firstdev = NULL; dev != NULL; dev = dev-&gt;next) {
                if (dev-&gt;queue != NULL &amp;&amp; (*firstdev == NULL || cmp(dev-&gt;queue, (*firstdev)-&gt;queue) &lt; 0)) {
                    *firstdev = dev;
                }
            }
        }
        
</span><span class="org-block-end-line">#+END_EXAMPLE   
</span>&#25509;&#30528;&#23601;&#26159;call printNextEntry()&#36827;&#34892;log&#36755;&#20986;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        static void printNextEntry(log_device_t* dev) {
            maybePrintStart(dev);
            if (g_printBinary) {
                printBinary(&amp;dev-&gt;queue-&gt;entry);
            } else {
                processBuffer(dev, &amp;dev-&gt;queue-&gt;entry);
            }
            skipNextEntry(dev);
        }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#22914;&#26524;&#20013;&#25351;&#23450;&#20102;"B"&#21442;&#25968;,log&#23558;&#19981;&#20250;&#34987;&#35299;&#26512;,&#30452;&#25509;&#20197;&#20108;&#36827;&#21046;&#30340;&#26041;&#24335;&#36755;&#20986;,&#21542;&#21017;,&#35843;&#29992; processBuffer()&#23545;log entry&#36827;&#34892;&#35299;&#26512;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
    if (dev-&gt;binary) {
        err = android_log_processBinaryLogBuffer(buf, &amp;entry, g_eventTagMap,
                binaryMsgBuf, sizeof(binaryMsgBuf));
        //printf("&gt;&gt;&gt; pri=%d len=%d msg='%s'\n",
        //    entry.priority, entry.messageLen, entry.message);
    } else {
        err = android_log_processLogBuffer(buf, &amp;entry);
    }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>android log system&#30446;&#21069;&#26377;&#22235;&#31181;&#31867;&#22411;&#30340;log: main, system, radio, event. &#20854;&#20013;&#21069;&#19977;&#31181;&#21487;&#20197;&#20998;&#20026;&#21516;&#19968;&#31867;&#22411;,log&#21487;&#20197;&#36890;&#36807;android_log_processLogBuffer()&#30452;&#25509;&#35299;&#26512;&#25104;&#20154;&#31867;&#21487;&#20197;&#35835;&#25026;&#30340;&#25991;&#23383;. event log&#21017;&#31245;&#26377;&#19981;&#21516;,&#35299;&#26512;&#21518;&#30340;log&#20063;&#35201;&#36890;&#36807;&#30456;&#24212;&#30340;&#25991;&#20214;&#25165;&#33021;&#35835;&#25026;. &#36825;&#37324;&#20027;&#35201;&#30475;&#19968;&#19979;&#24120;&#35268;log&#30340;&#35299;&#26512;.

android_log_processLogBuffer()&#30340;&#21442;&#25968;&#26377;&#20004;&#20010;,&#31532;&#19968;&#20010;&#26159;logger_entry&#21464;&#37327;,&#31532;&#20108;&#20010;&#26159;AndroidLogEntry&#21464;&#37327;,&#20854;&#23454;&#36825;&#20004;&#20010;&#32467;&#26500;&#20307;&#30340;&#20869;&#23481;&#22823;&#33268;&#30456;&#21516;,&#21482;&#19981;&#36807;&#21518;&#19968;&#20010;&#21253;&#21547;&#30340;&#20449;&#24687;&#26356;&#22810;&#19968;&#20123;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        struct logger_entry {
            uint16_t    len;    /* length of the payload */
            uint16_t    __pad;  /* no matter what, we get 2 bytes of padding */
            int32_t     pid;    /* generating process's pid */
            int32_t     tid;    /* generating process's tid */
            int32_t     sec;    /* seconds since Epoch */
            int32_t     nsec;   /* nanoseconds */
            char        msg[0]; /* the entry's payload */
        };
                
        typedef struct AndroidLogEntry_t {
            time_t tv_sec;
            long tv_nsec;
            android_LogPriority priority;
            int32_t pid;
            int32_t tid;
            const char * tag;
            size_t messageLen;
            const char * message;
        } AndroidLogEntry;
        
        int android_log_processLogBuffer(struct logger_entry *buf,
                                         AndroidLogEntry *entry)
        {
            entry-&gt;tv_sec = buf-&gt;sec;
            entry-&gt;tv_nsec = buf-&gt;nsec;
            entry-&gt;pid = buf-&gt;pid;
            entry-&gt;tid = buf-&gt;tid;
        
            int msgStart = -1;
            int msgEnd = -1;
        
            int i;
            for (i = 1; i &lt; buf-&gt;len; i++) {
                if (buf-&gt;msg[i] == '\0') {
                    if (msgStart == -1) {
                        msgStart = i + 1;
                    } else {
                        msgEnd = i;
                        break;
                    }
                }
            }
        
            entry-&gt;priority = buf-&gt;msg[0];
            entry-&gt;tag = buf-&gt;msg + 1;
            entry-&gt;message = buf-&gt;msg + msgStart;
            entry-&gt;messageLen = msgEnd - msgStart;
        
            return 0;
        }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#21487;&#20197;&#30475;&#21040;&#36716;&#25442;&#20989;&#25968;&#20027;&#35201;&#26159;&#25226;logger_entry&#30340;msg&#32473;&#20998;&#21106;&#25104;&#19977;&#20010;&#37096;&#20998;:priority, tag, message.

&#25509;&#30528;&#20250;&#35843;&#29992;android_log_shouldPrintLine()&#26816;&#26597;&#35813;&#35813;tag&#21450;&#35813;level&#30340;log&#26159;&#21542;&#24212;&#35813;&#34987;&#25171;&#21360;,&#22914;&#26524;&#26159;,&#21017;&#35843;&#29992;android_log_printLogLine()&#25171;&#21360;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        /* android_log_printLogLine() */

    outBuffer = android_log_formatLogLine(p_format, defaultBuffer,
            sizeof(defaultBuffer), entry, &amp;totalLen);

    do {
        ret = write(fd, outBuffer, totalLen);
    } while (ret &lt; 0 &amp;&amp; errno == EINTR);

        ......

    if (outBuffer != defaultBuffer) {
        free(outBuffer);
    }

&#21069;&#38754;&#35762;&#36807;&#21487;&#20197;&#36890;&#36807;&#21442;&#25968;"-v"&#35774;&#32622;&#25171;&#21360;&#30340;log&#26684;&#24335;,&#25152;&#20197;android_log_formatLogLine()&#30340;&#20316;&#29992;&#23601;&#26159;&#23558;entry &#36716;&#25442;&#20026;&#26368;&#32456;&#30340;&#25171;&#21360;&#26684;&#24335;.


        /* android_log_formatLogLine() */

    priChar = filterPriToChar(entry-&gt;priority);
    ptm = localtime(&amp;(entry-&gt;tv_sec));
    strftime(timeBuf, sizeof(timeBuf), "%m-%d %H:%M:%S", ptm);

    size_t prefixLen, suffixLen;

    switch (p_format-&gt;format) {
        case FORMAT_TAG:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "%c/%-8s: ", priChar, entry-&gt;tag);
            strcpy(suffixBuf, "\n"); suffixLen = 1;
            break;
        case FORMAT_PROCESS:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "%c(%5d) ", priChar, entry-&gt;pid);
            suffixLen = snprintf(suffixBuf, sizeof(suffixBuf),
                "  (%s)\n", entry-&gt;tag);
            break;
        case FORMAT_THREAD:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "%c(%5d:%5d) ", priChar, entry-&gt;pid, entry-&gt;tid);
            strcpy(suffixBuf, "\n");
            suffixLen = 1;
            break;
        case FORMAT_RAW:
            prefixBuf[0] = 0;
            prefixLen = 0;
            strcpy(suffixBuf, "\n");
            suffixLen = 1;
            break;
        case FORMAT_TIME:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "%s.%03ld %c/%-8s(%5d): ", timeBuf, entry-&gt;tv_nsec / 1000000,
                priChar, entry-&gt;tag, entry-&gt;pid);
            strcpy(suffixBuf, "\n");
            suffixLen = 1;
            break;
        case FORMAT_THREADTIME:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "%s.%03ld %5d %5d %c %-8s: ", timeBuf, entry-&gt;tv_nsec / 1000000,
                entry-&gt;pid, entry-&gt;tid, priChar, entry-&gt;tag);
            strcpy(suffixBuf, "\n");
            suffixLen = 1;
            break;
        case FORMAT_LONG:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "[ %s.%03ld %5d:%5d %c/%-8s ]\n",
                timeBuf, entry-&gt;tv_nsec / 1000000, entry-&gt;pid,
                entry-&gt;tid, priChar, entry-&gt;tag);
            strcpy(suffixBuf, "\n\n");
            suffixLen = 2;
            prefixSuffixIsHeaderFooter = 1;
            break;
        case FORMAT_BRIEF:
        default:
            prefixLen = snprintf(prefixBuf, sizeof(prefixBuf),
                "%c/%-8s(%5d): ", priChar, entry-&gt;tag, entry-&gt;pid);
            strcpy(suffixBuf, "\n");
            suffixLen = 1;
            break;
    }

    size_t numLines;
    size_t i;
    char *p;
    size_t bufferSize;
    const char *pm;


    ret[0] = '\0';       /* to start strcat off */

    p = ret;
    pm = entry-&gt;message;


</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#39318;&#20808;&#20250;&#23558;&#25968;&#23383;&#26684;&#24335;&#30340;priority&#36716;&#20026;&#23383;&#31526;&#26684;&#24335;,&#25509;&#30528;&#29983;&#25104;&#26684;&#24335;&#21270;&#26102;&#38388;&#23383;&#31526;&#20018;.&#28982;&#21518;&#36827;&#20837;switch&#21028;&#26029;&#24403;&#21069;&#30340;format&#24418;&#24335;,&#24182;&#29983;&#25104;&#23545;&#24212;&#30340;prefix. &#22240;&#20026;snprintf/vsnprintf&#26377;&#20010;&#29305;&#28857;:&#34429;&#28982;&#23427;&#20204;&#26368;&#22810;&#21482;&#20250;&#21521;buffer&#20889;&#20837;&#25351;&#23450;&#38271;&#24230;&#30340;&#23383;&#31526;&#20018;(&#20063;&#23601;&#26159;&#35828;,&#22914;&#26524;buffer&#19981;&#36275;,&#23383;&#31526;&#20018;&#20250;&#34987;&#25130;&#26029;),&#20294;&#26159;,&#23427;&#20204;&#30340;&#36820;&#22238;&#20540;&#30830;&#26159;&#29702;&#24819;&#24773;&#20917;&#19979;(buffer&#36275;&#22815;&#22823;)&#21487;&#20197;&#20889;&#20837;&#30340;&#23383;&#31526;&#20018;&#38271;&#24230;.&#25152;&#20197;&#31243;&#24207;&#25509;&#19979;&#26469;&#20250;&#21028;&#26029;&#36820;&#22238;&#20540;&#36319;buffer size&#26159;&#21542;&#30456;&#31561;.

<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        /* android_log_formatLogLine() */
    if(prefixLen &gt;= sizeof(prefixBuf))
        prefixLen = sizeof(prefixBuf) - 1;
    if(suffixLen &gt;= sizeof(suffixBuf))
        suffixLen = sizeof(suffixBuf) - 1;

&#25509;&#30528;&#20250;&#36941;&#21382;msg&#20013;&#30340;"\n"&#21028;&#26029;&#35813;&#26465;log&#38656;&#35201;&#20998;&#20960;&#34892;&#25171;&#20986;,&#27599;&#34892;&#25171;&#20986;&#30340;log&#37117;&#20250;&#26377;prefix&#23383;&#31526;&#20018;

        /* android_log_formatLogLine() */
    if (prefixSuffixIsHeaderFooter) {
        numLines = 1;
    } else {
        pm = entry-&gt;message;
        numLines = 0;

        while (pm &lt; (entry-&gt;message + entry-&gt;messageLen)) {
            if (*pm++ == '\n') numLines++;
        }
        if (pm &gt; entry-&gt;message &amp;&amp; *(pm-1) != '\n') numLines++;
    }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#22312;&#20989;&#25968;&#21442;&#25968;&#20013;&#24050;&#32463;&#20256;&#20837;&#20102;&#23384;log&#30340;buffer,&#20294;&#26159;,&#22914;&#26524;&#38656;&#35201;&#25171;&#21360;&#30340;log &#38271;&#24230;&#36229;&#36807;&#20102;buffer size,&#21017;&#31995;&#32479;&#20250;&#37325;&#26032;malloc&#19968;&#20010;&#26032;&#30340;buffer,&#35760;&#20303;:&#36825;&#20010;buffer&#38656;&#35201;&#22312;&#20989;&#25968;&#22806;free&#25481;!!!!(logcat&#30340;&#20570;&#27861;&#26159;&#21028;&#26029;&#20989;&#25968;&#36820;&#22238;&#20540;&#26159;&#21542;&#31561;&#20110;&#20256;&#20837;&#30340;buffer,&#22914;&#26524;&#19981;&#26159;,&#21017;&#34920;&#31034;&#26377;&#26032;buffer malloc,&#23601;&#20250;free&#25481;)
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">
        /* android_log_formatLogLine() */
    bufferSize = (numLines * (prefixLen + suffixLen)) + entry-&gt;messageLen + 1;

    if (defaultBufferSize &gt;= bufferSize) {
        ret = defaultBuffer;
    } else {
        ret = (char *)malloc(bufferSize);

        if (ret == NULL) {
            return ret;
        }
    }

        /* android_log_printLogLine() */
    if (outBuffer != defaultBuffer) {
        free(outBuffer);
    }

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#26368;&#21518;&#26159;&#29983;&#25104;&#26368;&#32456;&#30340;log&#23383;&#31526;&#20018;.&#23545;&#20110;"long"&#26684;&#24335;&#30340;log format&#26469;&#35762;,prefix&#21482;&#38656;&#25171;&#21360;&#19968;&#27425;,&#25152;&#20197;&#19981;&#38656;&#35201;&#36941;&#21382;msg&#20013;&#30340;"\n".&#21542;&#21017;,&#23545;&#20110;&#27599;&#34892;log&#37117;&#35201;&#21152;&#19978;prefix.

<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">    if (prefixSuffixIsHeaderFooter) {
        strcat(p, prefixBuf);
        p += prefixLen;
        strncat(p, entry-&gt;message, entry-&gt;messageLen);
        p += entry-&gt;messageLen;
        strcat(p, suffixBuf);
        p += suffixLen;
    } else {
        while(pm &lt; (entry-&gt;message + entry-&gt;messageLen)) {
            const char *lineStart;
            size_t lineLen;
            lineStart = pm;

            // Find the next end-of-line in message
            while (pm &lt; (entry-&gt;message + entry-&gt;messageLen)
                    &amp;&amp; *pm != '\n') pm++;
            lineLen = pm - lineStart;

            strcat(p, prefixBuf);
            p += prefixLen;
            strncat(p, lineStart, lineLen);
            p += lineLen;
            strcat(p, suffixBuf);
            p += suffixLen;

            if (*pm == '\n') pm++;
        }
    }

    if (p_outLength != NULL) {
        *p_outLength = p - ret;
    }

    return ret;

</span><span class="org-block-end-line">#+END_EXAMPLE
</span>&#20989;&#25968;&#36820;&#22238;&#21518;,&#23601;&#25226;&#26368;&#32456;&#23383;&#31526;&#20018;&#20889;&#21040;&#36755;&#20986;. 

OK,logcat&#30340;&#29992;&#27861;&#21450;&#23454;&#29616;&#27969;&#31243;&#21040;&#36825;&#37324;&#23601;&#22522;&#26412;&#32467;&#26463;&#20102;.

<span class="org-level-1">* Footnotes</span>

<span class="org-footnote">[0]</span>  ignore 
</pre>
  </body>
</html>
