<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.43 in css mode. -->
<html>
  <head>
    <title>Memory-Optimization.org</title>
    <style type="text/css">
    <!--
      body {
        color: #DCDCCC;
        background-color: #3F3F3F;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #7F9F7F;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #7F9F7F;
      }
      .org-document-info {
        /* org-document-info */
        color: #afeeee;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-document-title {
        /* org-document-title */
        color: #afeeee;
        font-weight: bold;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #DFAF8F;
        font-size: 130%;
        text-decoration: overline;
      }
      .org-link {
        /* org-link */
        color: #D0BF8F;
        text-decoration: underline;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #7F9F7F;
      }
      .type {
        /* font-lock-type-face */
        color: #7CB8BB;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #DFAF8F;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+OPTIONS: toc:t H:3</span>
<span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">Luis404
</span><span class="org-document-info-keyword">#+EMAIL:</span> <span class="org-document-info">luisxu404@gmail.com
</span>
<span class="org-document-info-keyword">#+TITLE:</span> <span class="org-document-title">Memory Optimization
</span>(&#25345;&#32493;&#26356;&#26032;)

For a Samsung Galaxy Note 4 memory usage high issue: Setting-&gt;App-&gt;Running.
(Not that high in Nexus5).Try to analyze why this happens.

<span class="org-level-1">* GC_XXX logs</span>
After first install and run, the memory usage is about 200MB.
about 20+ GC_FOR_ALLOC logs show. as this

<span class="org-block-begin-line">#+BEGIN_QUOTE
</span>// GC_FOR_ALLOC: A garbage collection caused because your app attempted to allocate memory when 
// your heap was already full, so the system had to stop your app and reclaim memory.
02-02 15:51:24.227  8351  8351 D dalvikvm: GC_FOR_ALLOC freed 2786K, 12% free 75674K/85580K, paused 62ms, total 62ms<span class="org-meta-line">
</span><span class="org-block-end-line">#+END_QUOTE
</span>
Do some image related operations(wallpaper,recommendation...), the memory become 260+MB, 
More GC_FOR_ALLOC logs show, and serveral GC_EXPLICIT logs.

"GC_EXPLICIT
An explicit garbage collection, such as when you call gc() 
(which you should avoid calling and instead trust the garbage collector to run when needed)."

From the GC logs, check if <span class="bold">*75674K/85580K*</span> is continue growing, if so, there maybe leak.
<span class="org-level-1">* DDMS VM heap</span>
Use ddms vm heap feature to chech the heap change while interacting with app,
as blew.

<span class="org-link"><a href="file:../../../assets/images/ddmsvmheap.png">file:../../../assets/images/ddmsvmheap.png</a></span>

From the image, the 1-byte array mallocs about 84MB, the <span class="bold">*56byte*</span> malloc is
about more than 2000.
<span class="org-level-1">* Allocation Tracker</span>
Allcation Tracker can show all the allocations and the code path.
<span class="org-level-1">* dumpsys meminfo pid/packagename</span>
This command used to  lists all of your app's current allocations, measured in kilobytes.

Import columns and line combinations need concerded:
1. Dalvik heap + private dirty.
   It's your app's heap allocation.
2. .dex mmap + private clean.
   The own code size of your app.
3. Unknow + private Dirty.
   Allocation belongs to your app but can't classified by system.
4. private dirty column.
   Your own memory use, this memory is pages that been modified, 
   so must stay in memory.
5. private clean colum.
   Still your apps own memory alloc, but not modified, then can be 
   paged out.
6. <span class="bold">*Appcontext and Activity*</span>.
   A very important part to track activity memory leak.

Below is a dumpsys meminfo output, there maybe activity leak, because 
when the first activity called <span class="bold">*finish()*</span>, and we suppose it be recycled
after GC. But it's not.

<span class="org-block-begin-line">#+Begin_SRC c
</span>MEMINFO <span class="type">in</span> <span class="variable-name">pid</span> 10391 [com.luis.404] 
                   Pss  Private  Private  Swapped     Heap     Heap     Heap
                 Total    Dirty    Clean    Dirty     Size    Alloc     Free
                ------   ------   ------   ------   ------   ------   ------
  Native Heap       48       48        0        0    53504     7614    25489
  Dalvik Heap    18984    18860        0        0    34808    26160     8648
 Dalvik Other     3772     3740        0        0                           
        Stack      152      152        0        0                           
    Other dev     3388     3380        8        0                           
     .so mmap     4759     3576      620        0                           
    .jar mmap        4        0        4        0                           
    .apk mmap      343        0      228        0                           
    .ttf mmap        1        0        0        0                           
    .dex mmap     5851       80     5340        0                           
   Other mmap        8        4        0        0                           
      Unknown    27345    27344        0        0                           
        TOTAL    64655    57184     6200        0    88312    33774    34137
 
 Objects
               Views:       19         ViewRootImpl:        1
         AppContexts:        5           Activities:        2
              Assets:        5        AssetManagers:        5
       Local Binders:       78        Proxy Binders:       24
    Death Recipients:        0
     OpenSSL Sockets:        3
 
 SQL
         MEMORY_USED:     1103
  PAGECACHE_OVERFLOW:      667          MALLOC_SIZE:       62
<span class="org-block-end-line">#+END_SRC
</span><span class="org-level-1">* dumpsys procstats packagename</span>
<span class="org-level-1">* heap dump</span>
It will dump to a hprof file.
<span class="org-level-1">* some good post online</span>
<span class="org-link"><a href="http://blog.hsc.com/android/technology-trends/android-memory-optimization/">http://blog.hsc.com/android/technology-trends/android-memory-optimization/</a></span>
<span class="org-link"><a href="https://developer.android.com/tools/debugging/debugging-memory.html">https://developer.android.com/tools/debugging/debugging-memory.html</a></span>
</pre>
  </body>
</html>
