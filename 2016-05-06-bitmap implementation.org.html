<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.43 in css mode. -->
<html>
  <head>
    <title>2016-05-06-bitmap implementation.org</title>
    <style type="text/css">
    <!--
      body {
        color: #DCDCCC;
        background-color: #3F3F3F;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .org-block {
        /* org-block */
        color: #009acd;
      }
      .org-block-begin-line {
        /* org-block-begin-line */
        color: #7F9F7F;
      }
      .org-block-end-line {
        /* org-block-end-line */
        color: #7F9F7F;
      }
      .org-code {
        /* org-code */
        color: #b3b3b3;
      }
      .org-document-info {
        /* org-document-info */
        color: #afeeee;
      }
      .org-document-info-keyword {
        /* org-document-info-keyword */
        color: #b3b3b3;
      }
      .org-level-1 {
        /* org-level-1 */
        color: #DFAF8F;
        font-size: 130%;
        text-decoration: overline;
      }
      .org-level-2 {
        /* org-level-2 */
        color: #BFEBBF;
        font-size: 120%;
      }
      .org-meta-line {
        /* org-meta-line */
        color: #7F9F7F;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="org-meta-line">#+OPTIONS: num:nil</span>
<span class="org-meta-line">#+OPTIONS: ^:nil</span>
<span class="org-meta-line">#+OPTIONS: H:nil</span>
<span class="org-meta-line">#+OPTIONS: toc:nil</span>
<span class="org-document-info-keyword">#+AUTHOR:</span> <span class="org-document-info">Zhengchao Xu
</span><span class="org-document-info-keyword">#+EMAIL:</span> <span class="org-document-info">xuzhengchaojob@gmail.com
</span>
<span class="org-block-begin-line">#+BEGIN_HTML
</span><span class="org-block">---
layout: post
title: &#19968;&#20010;bitmap&#30340;&#23454;&#29616;&#20195;&#30721;
categories: [Android]
tag: [java, android]
---
</span><span class="org-block-end-line">#+END_HTML
</span>
&#26159;&#22312;&#38405;&#35835;RecyclerView&#30340;&#28304;&#30721;&#26102;, &#22312;&#37324;&#38754;&#21457;&#29616;&#20102;&#35813;&#37096;&#20998;&#20195;&#30721;, &#35273;&#24471;&#24456;&#26377;&#36259;, &#25925;&#35760;&#24405;&#19968;&#19979;. \\
&#35813;&#37096;&#20998;&#20195;&#30721;&#29992;&#20110;&#23454;&#29616;&#20102;bitmap, &#22312;RecyclerView&#30340;&#21253;&#20013;&#29992;&#20110;&#31649;&#29702;&#23376;view. \\
&#20195;&#30721;&#20301;&#20110;RecyclerView&#21253;&#30340; ChildHelper.java &#25991;&#20214;, &#26159;&#19968;&#20010;&#23376;&#31867;, &#31867;&#21517;&#20026; <span class="bold">*Bucket*</span>.

<span class="org-level-1">* &#20171;&#32461;</span>
&#35813;&#31867;&#20351;&#29992;&#19968;&#20010; <span class="bold">*LONG&#38142;&#34920;*</span> &#20316;&#20026;bitmap&#30340;&#23384;&#20648;&#22120;, &#35813;&#32467;&#26500;&#30340;&#20027;&#35201;&#29305;&#28857;&#21253;&#25324;:
1. &#29702;&#35770;&#19978;&#21487;&#20197;&#23384;&#25918;&#26080;&#38480;&#22810;&#20010;bit.
2. &#25903;&#25345;&#21160;&#24577;&#25193;&#23637;.
3. &#25903;&#25345;&#28155;&#21152;/&#21024;&#38500;/&#25554;&#20837;/&#32479;&#35745;&#31561;&#25805;&#20316;.
<span class="org-level-1">* &#20195;&#30721;&#23454;&#29616;</span>
<span class="org-level-2">** &#25104;&#21592;&#21464;&#37327;</span>
&#35813;&#31867;&#21482;&#26377;&#22235;&#20010;&#21464;&#37327;, BITS_PER_WORD&#20195;&#31508;&#27599;&#20010;Bucket&#23545;&#35937;&#21487;&#20197;&#23384;&#25918;&#30340;bit&#25968;&#37327;,
&#36825;&#37324;&#20351;&#29992;&#20102;Long&#31867;&#22411;, &#25925;&#21487;&#20197;&#23384;&#25918;64&#20301;. 
mData&#26159;&#20855;&#20307;&#23384;&#25918;bit&#30340;&#25968;&#25454;, next&#25351;&#21521;&#19979;&#19968;&#20010;Bucket&#23545;&#35937;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">static class Bucket {
  final static int BITS_PER_WORD = Long.SIZE;
  final static long LAST_BIT = 1L &lt;&lt; (Long.SIZE - 1);
  long mData = 0;
  Bucket next;
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#35774;&#32622;bit: set(index)</span>
<span class="org-code">~set(int index)~</span> &#20989;&#25968;&#29992;&#20110;&#23558;index&#20301;&#32622;&#30340;bit&#35774;&#32622;&#20026;1. \\
&#35813;&#20989;&#25968;&#39318;&#20808;&#26816;&#26597;&#35201;&#25554;&#20837;&#30340;&#20301;&#32622;, &#26159;&#19981;&#26159;&#22823;&#20110;&#24403;&#21069;&#30340;Bucket&#30340;&#33539;&#22260;,
1. &#22914;&#26524;&#19981;&#22823;&#20110;, &#37027;&#20040;&#36890;&#36807; "&#25110;" &#26469;&#35774;&#32622;&#35813;bit&#20301;.
2. &#22914;&#26524;&#22823;&#20110;, &#20808;&#35843;&#29992;ensureNext()&#20989;&#25968;&#30830;&#23450;&#26159;&#21542;&#38656;&#35201;&#29983;&#25104;&#19968;&#20010;&#26032;
   &#30340;Bucket&#25918;&#21040;&#38142;&#34920;&#23614;&#37096;, &#28982;&#21518;&#35843;&#29992;&#19979;&#20010;Bucket&#30340;set()&#20989;&#25968;, &#20294;&#26159;&#20256;&#20837;&#30340;&#21442;&#25968;
   &#20026; index &#20943;&#21435;&#24403;&#21069;Bucket&#30340;&#38271;&#24230;(64). &#22914;&#26524;&#19979;&#20010;bucket&#36824;&#26159;&#19981;&#28385;&#36275;, &#20250;&#19968;&#30452;
   &#39034;&#30528;&#38142;&#34920;&#35843;&#29992;&#19979;&#21435;, &#30452;&#21040;&#25214;&#21040;&#19968;&#20010;&#21512;&#36866;&#30340;&#20301;&#32622;. 
   
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">void set(int index) {
      if (index &gt;= BITS_PER_WORD) {
           ensureNext();
           next.set(index - BITS_PER_WORD);
      } else {
           mData |= 1L &lt;&lt; index;
      }
}
</span><span class="org-block-end-line">#+END_EXAMPLE
</span>
ensureNext()&#30340;&#20195;&#30721;&#22914;&#19979;:
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">private void ensureNext() {
     if (next == null) {
          next = new Bucket();
     }
}
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#28165;&#38500;&#25805;&#20316;: clear(index)</span>
   &#20854;&#21407;&#29702;&#36319;&#35774;&#32622;&#19968;&#26679;, &#36890;&#36807; "&#19982;" &#25805;&#20316;&#23558;bit&#20301;&#28165;&#38500;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        void clear(int index) {
            if (index &gt;= BITS_PER_WORD) {
                if (next != null) {
                    next.clear(index - BITS_PER_WORD);
                }
            } else {
                mData &amp;= ~(1L &lt;&lt; index);
            }
        }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#21028;&#26029;: get(index)</span>
&#36882;&#24402;&#26597;&#25214;&#38142;&#34920;, &#21028;&#26029;&#25351;&#23450;&#20301;&#32622;&#26159;&#21542;&#35774;&#32622;&#20102;bit&#20301;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        boolean get(int index) {
            if (index &gt;= BITS_PER_WORD) {
                ensureNext();
                return next.get(index - BITS_PER_WORD);
            } else {
                return (mData &amp; (1L &lt;&lt; index)) != 0;
            }
        }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#25554;&#20837;: insert(index, b)</span>
&#22312;&#25351;&#23450;&#30340;&#20301;&#32622;&#25554;&#20837;&#19968;&#20010;bit&#30340;&#35774;&#32622;, &#35813;&#20301;&#32622;&#21518;&#38754;&#30340;&#20869;&#23481;&#21518;&#31227;. 
&#36825;&#20010;&#25805;&#20316;&#26159;&#36890;&#36807;&#19979;&#36848;&#27493;&#39588;&#23454;&#29616;:
1. &#20808;&#33719;&#21462;&#35813;&#20301;&#32622;&#20043;&#21069;&#20301;&#32622;&#30340;mask: <span class="org-code">~long mask = (1L &lt;&lt; index) - 1;~</span>
2. &#36890;&#36807;"&#19982;"&#25805;&#20316;&#33719;&#21462;&#35813;&#20301;&#32622;&#20043;&#21069;&#30340;&#20869;&#23481;. 
3. &#36890;&#36807;"&#19982;"&#25805;&#20316;&#19982;"&#31227;&#20301;"&#25805;&#20316;&#23558;&#35813;&#20301;&#32622;&#20043;&#21518;&#30340;&#20869;&#23481;&#21518;&#31227;&#19968;&#20301;. 
4. &#20351;&#29992;&#31532;&#20108;&#20010;&#21442;&#25968;&#35774;&#32622;&#35813;&#20301;&#32622;&#30340;bit&#20540;.
   
&#27880;: &#22914;&#26524;&#25554;&#20837;&#20043;&#21069;, Bucket&#23545;&#35937;&#30340;&#26368;&#39640;&#20301;&#30340;bit&#34987;&#35774;&#32622;(&#20026;1), &#37027;&#20040;&#22312;&#21518;&#31227;&#36807;&#31243;&#20013;,
&#35813;&#20301;&#32622;&#20250;&#34987;&#31227;&#38500;&#35813;Bucket, &#25152;&#20197;&#38656;&#35201;&#35760;&#24405;&#19979;&#26469;, &#23558;&#20854;&#37325;&#26032;&#25554;&#20837;&#21040;&#19979;&#19968;&#20010;Bucket&#20013;.
&#36825;&#20010;&#36807;&#31243;&#20250;&#19968;&#30452;&#25345;&#32493;&#19979;&#21435;, &#30452;&#21040;&#30896;&#21040;&#19968;&#20010;&#26368;&#39640;&#20301;&#27809;&#34987;&#35774;&#32622;&#30340;Bucket.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        void insert(int index, boolean value) {
            if (index &gt;= BITS_PER_WORD) {
                ensureNext();
                next.insert(index - BITS_PER_WORD, value);
            } else {
                final boolean lastBit = (mData &amp; LAST_BIT) != 0;
                long mask = (1L &lt;&lt; index) - 1;
                final long before = mData &amp; mask;
                final long after = ((mData &amp; ~mask)) &lt;&lt; 1;
                mData = before | after;
                if (value) {
                    set(index);
                } else {
                    clear(index);
                }
                if (lastBit || next != null) {
                    ensureNext();
                    next.insert(0, lastBit);
                }
            }
        }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span><span class="org-level-2">** &#31227;&#38500;: remove(index)</span>
&#35813;&#20989;&#25968;&#29992;&#20110;&#23558;&#35813;&#20301;&#32622;&#30340;bit&#20301;&#31227;&#38500;, &#24182;&#23558;&#20854;&#21518;&#38754;&#30340;bit&#21069;&#31227;&#19968;&#20301;. 
&#35813;&#20989;&#25968;&#30340;&#27493;&#39588;:
1. &#36890;&#36807;"&#19982;"&#25805;&#20316;&#23558;index&#20301;&#32622;&#30340;bit&#35774;&#20026;0.
2. &#32531;&#23384;index&#20043;&#21069;&#30340;&#25968;&#25454;.
3. &#35843;&#29992;Long.rotateRight(), &#23558;index&#20043;&#21518;&#30340;&#25968;&#25454;&#21069;&#31227;&#19968;&#20301;.
   &#22240;&#20026;rotate&#20043;&#21069;&#24050;&#32463;&#23558;&#21069;&#38754;(&#20302;&#20301;)&#30340;&#25968;&#25454;&#32622;&#20301;0, &#25152;&#20197;rotate&#20043;&#21518;
   &#26368;&#39640;&#20301;&#19968;&#30452;&#26159;0. 
4. &#23558;&#31532;2&#27493;&#21644;&#31532;3&#27493;&#30340;&#25968;&#25454;&#21512;&#24182;&#25104;&#26032;&#25968;&#25454;.
5. &#21028;&#26029;&#19979;&#19968;&#20010;Bucket&#30340;&#31532;&#19968;&#20301;&#26159;&#21542;&#20026;1. &#22914;&#26524;&#26159;&#21017;&#23558;&#35813;bucket&#30340;&#26368;&#39640;&#20301;&#32622;1.
6. &#35843;&#29992;&#19979;&#19968;&#20010;bucket&#30340;remove(0). &#36941;&#21382;&#38142;&#34920;, &#37325;&#22797;&#36825;&#20010;&#25805;&#20316;.

<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        boolean remove(int index) {
            if (index &gt;= BITS_PER_WORD) {
                ensureNext();
                return next.remove(index - BITS_PER_WORD);
            } else {
                long mask = (1L &lt;&lt; index);
                final boolean value = (mData &amp; mask) != 0;
                mData &amp;= ~mask;
                mask = mask - 1;
                final long before = mData &amp; mask;
                // cannot use &gt;&gt; because it adds one.
                final long after = Long.rotateRight(mData &amp; ~mask, 1);
                mData = before | after;
                if (next != null) {
                    if (next.get(0)) {
                        set(BITS_PER_WORD - 1);
                    }
                    next.remove(0);
                }
                return value;
            }
        }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span>
<span class="org-level-2">** &#32479;&#35745;: countOnesBefore(index)</span>
&#32479;&#35745;index&#20043;&#21069;&#30340;bit&#25968;&#37327;. &#22522;&#20110; Long &#30340; bitCount() &#20989;&#25968;&#23454;&#29616;.
<span class="org-block-begin-line">#+BEGIN_EXAMPLE
</span><span class="org-block">        int countOnesBefore(int index) {
            if (next == null) {
                if (index &gt;= BITS_PER_WORD) {
                    return Long.bitCount(mData);
                }
                return Long.bitCount(mData &amp; ((1L &lt;&lt; index) - 1));
            }
            if (index &lt; BITS_PER_WORD) {
                return Long.bitCount(mData &amp; ((1L &lt;&lt; index) - 1));
            } else {
                return next.countOnesBefore(index - BITS_PER_WORD) + Long.bitCount(mData);
            }
        }
</span><span class="org-block-end-line">#+END_EXAMPLE
</span></pre>
  </body>
</html>
